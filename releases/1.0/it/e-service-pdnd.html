<!DOCTYPE html>

<html lang="it" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>15.2. e-Service PDND &#8212; IT-Wallet Technical Documentation - Release 1.0 - 1.0.0</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/basic_mod.css?v=9b2032db" />
    <link rel="stylesheet" type="text/css" href="_static/itwallet-override.css?v=63798874" />
    <script src="_static/documentation_options.js?v=3fd72285"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/translations.js?v=da26b4cc"></script>
    <script src="_static/js/theme.js"></script>
    <script src="_static/js/petite-vue.js"></script>
    <link rel="icon" href="https://avatars.githubusercontent.com/u/15377824?s=48&amp;v=4"/>
    <link rel="index" title="Indice" href="genindex.html" />
    <link rel="search" title="Cerca" href="search.html" />
    <link rel="next" title="15.3. Piani di Test" href="test-plans.html" />
    <link rel="prev" title="15.1. Istanza dell&#39;Applicazione Mobile" href="mobile-application-instance.html" /> 
  </head><body data-dark_mode_code_blocks="true">

<div id="top_nav">
    

    <nav>
        
            
        

        <p id="toggle_sidebar">
            <a href="#" title="Toggle sidebar">|||</a>
        </p>
        <h1><a href="index.html" title="Go to homepage">IT-Wallet Technical Documentation - Release 1.0 - 1.0.0</a></h1>
            <a id="source_link" href="https://github.com/italia/eudi-wallet-it-docs">
    
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512">
            <path fill="white" d="M 244.8,8 C 106.1,8 0,113.3 0,252 c 0,110.9 69.8,205.8 169.5,239.2 12.8,2.3 17.3,-5.6 17.3,-12.1 0,-6.2 -0.3,-40.4 -0.3,-61.4 0,0 -70,15 -84.7,-29.8 0,0 -11.4,-29.1 -27.8,-36.6 0,0 -22.9,-15.7 1.6,-15.4 0,0 24.9,2 38.6,25.8 21.9,38.6 58.6,27.5 72.9,20.9 2.3,-16 8.8,-27.1 16,-33.7 -55.9,-6.2 -112.3,-14.3 -112.3,-110.5 0,-27.5 7.6,-41.3 23.6,-58.9 -2.6,-6.5 -11.1,-33.3 2.6,-67.9 20.9,-6.5 69,27 69,27 20,-5.6 41.5,-8.5 62.8,-8.5 21.3,0 42.8,2.9 62.8,8.5 0,0 48.1,-33.6 69,-27 13.7,34.7 5.2,61.4 2.6,67.9 16,17.7 25.8,31.5 25.8,58.9 0,96.5 -58.9,104.2 -114.8,110.5 9.2,7.9 17,22.9 17,46.4 0,33.7 -0.3,75.4 -0.3,83.6 0,6.5 4.6,14.4 17.3,12.1 C 428.2,457.8 496,362.9 496,252 496,113.3 383.5,8 244.8,8 Z"/>
        </svg>
    
</a>
        

        <a id="mode_toggle" href="#" @click.prevent="handleClick" :title="mode">
    <template v-if="mode == 'light'">
        <svg width="100%" height="100%" viewBox="0 0 79 80" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;"><g id="mode_light"><rect id="Bounds" x="0" y="-0" width="78.623" height="79.049" style="fill:none;"/><circle cx="39.311" cy="39.524" r="15.734" style="fill:#fff;"/><g id="beams"><g id="beam"><path id="beam1" serif:id="beam" d="M44.212,4.901c0,-2.705 -2.196,-4.901 -4.901,-4.901c-2.704,-0 -4.9,2.196 -4.9,4.901l-0,9.614c-0,2.705 2.196,4.901 4.9,4.901c2.705,0 4.901,-2.196 4.901,-4.901l0,-9.614Z" style="fill:#fff;"/></g><g id="beam2" serif:id="beam"><path id="beam3" serif:id="beam" d="M67.48,18.073c1.913,-1.912 1.913,-5.018 0,-6.931c-1.912,-1.912 -5.018,-1.912 -6.931,0l-6.798,6.799c-1.912,1.912 -1.912,5.018 0,6.931c1.913,1.912 5.018,1.912 6.931,-0l6.798,-6.799Z" style="fill:#fff;"/></g><g id="beam4" serif:id="beam"><path id="beam5" serif:id="beam" d="M25.728,61.108c1.912,-1.913 1.912,-5.018 -0,-6.931c-1.913,-1.913 -5.019,-1.913 -6.931,-0l-6.799,6.798c-1.912,1.913 -1.912,5.019 0,6.931c1.913,1.913 5.019,1.913 6.931,0l6.799,-6.798Z" style="fill:#fff;"/></g><g id="beam6" serif:id="beam"><path id="beam7" serif:id="beam" d="M60.682,54.177c-1.913,-1.913 -5.018,-1.913 -6.931,-0c-1.912,1.913 -1.912,5.018 0,6.931l6.798,6.798c1.913,1.913 5.019,1.913 6.931,0c1.913,-1.912 1.913,-5.018 0,-6.931l-6.798,-6.798Z" style="fill:#fff;"/></g><g id="beam8" serif:id="beam"><path id="beam9" serif:id="beam" d="M4.901,34.623c-2.705,0 -4.901,2.196 -4.901,4.901c0,2.705 2.196,4.901 4.901,4.901l9.614,0c2.705,0 4.901,-2.196 4.901,-4.901c0,-2.705 -2.196,-4.901 -4.901,-4.901l-9.614,0Z" style="fill:#fff;"/></g><g id="beam10" serif:id="beam"><path id="beam11" serif:id="beam" d="M44.212,64.534c0,-2.705 -2.196,-4.901 -4.901,-4.901c-2.704,-0 -4.9,2.196 -4.9,4.901l-0,9.614c-0,2.705 2.196,4.901 4.9,4.901c2.705,-0 4.901,-2.196 4.901,-4.901l0,-9.614Z" style="fill:#fff;"/></g><g id="beam12" serif:id="beam"><path id="beam13" serif:id="beam" d="M18.929,11.142c-1.912,-1.912 -5.018,-1.912 -6.931,0c-1.912,1.913 -1.912,5.019 0,6.931l6.799,6.799c1.912,1.912 5.018,1.912 6.931,-0c1.912,-1.913 1.912,-5.019 -0,-6.931l-6.799,-6.799Z" style="fill:#fff;"/></g><g id="beam14" serif:id="beam"><path id="beam15" serif:id="beam" d="M64.108,34.623c-2.705,0 -4.901,2.196 -4.901,4.901c-0,2.705 2.196,4.901 4.901,4.901l9.614,0c2.705,0 4.901,-2.196 4.901,-4.901c-0,-2.705 -2.196,-4.901 -4.901,-4.901l-9.614,0Z" style="fill:#fff;"/></g></g></g></svg>
    </template>

    <template v-if="mode == 'dark'">
        <svg width="100%" height="100%" viewBox="0 0 79 80" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;"><g id="mode_dark"><rect id="Bounds" x="0" y="-0" width="78.623" height="79.049" style="fill:none;"/><circle cx="39.311" cy="39.524" r="15.734" style="fill:#fff;"/><g id="beams"><g id="beam"><path id="beam1" serif:id="beam" d="M44.212,14.515c0,-2.705 -2.196,-4.901 -4.901,-4.901c-2.704,0 -4.901,2.196 -4.901,4.901c0,2.705 2.197,4.901 4.901,4.901c2.705,0 4.901,-2.196 4.901,-4.901Z" style="fill:#fff;"/></g><g id="beam2" serif:id="beam"><path id="beam3" serif:id="beam" d="M60.662,24.892c1.902,-1.902 1.902,-4.99 0,-6.892l-0.04,-0.039c-1.901,-1.902 -4.989,-1.902 -6.891,-0c-1.901,1.901 -1.901,4.989 0,6.891l0.04,0.04c1.902,1.901 4.989,1.901 6.891,-0Z" style="fill:#fff;"/></g><g id="beam4" serif:id="beam"><path id="beam5" serif:id="beam" d="M25.732,61.103c1.91,-1.91 1.91,-5.011 0,-6.921l-0.009,-0.01c-1.91,-1.91 -5.012,-1.91 -6.921,-0c-1.91,1.91 -1.91,5.011 -0,6.921l0.01,0.01c1.909,1.91 5.011,1.91 6.92,-0Z" style="fill:#fff;"/></g><g id="beam6" serif:id="beam"><path id="beam7" serif:id="beam" d="M60.672,54.167c-1.907,-1.907 -5.004,-1.907 -6.911,0l-0.02,0.02c-1.907,1.907 -1.907,5.004 0,6.911c1.907,1.907 5.004,1.907 6.911,-0l0.02,-0.02c1.907,-1.907 1.907,-5.004 0,-6.911Z" style="fill:#fff;"/></g><g id="beam8" serif:id="beam"><path id="beam9" serif:id="beam" d="M14.52,34.623c-2.702,0 -4.896,2.194 -4.896,4.896l0,0.01c0,2.702 2.194,4.896 4.896,4.896c2.702,0 4.896,-2.194 4.896,-4.896l-0,-0.01c-0,-2.702 -2.194,-4.896 -4.896,-4.896Z" style="fill:#fff;"/></g><g id="beam10" serif:id="beam"><path id="beam11" serif:id="beam" d="M44.212,64.534c0,-2.705 -2.196,-4.901 -4.901,-4.901c-2.704,-0 -4.901,2.196 -4.901,4.901c0,2.704 2.197,4.9 4.901,4.9c2.705,0 4.901,-2.196 4.901,-4.9Z" style="fill:#fff;"/></g><g id="beam12" serif:id="beam"><path id="beam13" serif:id="beam" d="M25.73,17.943c-1.911,-1.911 -5.015,-1.911 -6.926,0l-0.005,0.005c-1.911,1.911 -1.911,5.015 0,6.926c1.911,1.911 5.015,1.911 6.926,0l0.005,-0.005c1.911,-1.911 1.911,-5.014 -0,-6.926Z" style="fill:#fff;"/></g><g id="beam14" serif:id="beam"><path id="beam15" serif:id="beam" d="M64.098,34.623c-2.699,0 -4.891,2.192 -4.891,4.892l-0,0.019c-0,2.699 2.192,4.891 4.891,4.891c2.7,0 4.892,-2.192 4.892,-4.891l0,-0.019c0,-2.7 -2.192,-4.892 -4.892,-4.892Z" style="fill:#fff;"/></g></g></g></svg>
    </template>

    <template v-if="mode == 'darkest'">
        <svg width="100%" height="100%" viewBox="0 0 79 80" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;"><g id="mode_darkest"><rect id="Bounds" x="0" y="-0" width="78.623" height="79.049" style="fill:none;"/><path d="M39.315,23.791c8.684,-0 15.734,7.05 15.734,15.733c0,8.684 -7.05,15.734 -15.734,15.734c-8.683,0 -15.733,-7.05 -15.733,-15.734c-0,-8.683 7.05,-15.733 15.733,-15.733Zm0,4.737c6.069,0 10.997,4.927 10.997,10.996c-0,6.069 -4.928,10.996 -10.997,10.996c-6.068,0 -10.996,-4.927 -10.996,-10.996c0,-6.069 4.928,-10.996 10.996,-10.996Z" style="fill:#fff;"/><g id="beams"><g id="beam"><path id="beam1" serif:id="beam" d="M44.216,14.515c0,-2.705 -2.196,-4.901 -4.901,-4.901c-2.704,0 -4.9,2.196 -4.9,4.901c-0,2.705 2.196,4.901 4.9,4.901c2.705,0 4.901,-2.196 4.901,-4.901Z" style="fill:#fff;"/></g><g id="beam2" serif:id="beam"><path id="beam3" serif:id="beam" d="M60.666,24.892c1.902,-1.902 1.902,-4.99 0,-6.892l-0.04,-0.039c-1.901,-1.902 -4.989,-1.902 -6.891,-0c-1.901,1.901 -1.901,4.989 0,6.891l0.04,0.04c1.902,1.901 4.99,1.901 6.891,-0Z" style="fill:#fff;"/></g><g id="beam4" serif:id="beam"><path id="beam5" serif:id="beam" d="M25.737,61.103c1.909,-1.91 1.909,-5.011 -0,-6.921l-0.01,-0.01c-1.91,-1.91 -5.011,-1.91 -6.921,-0c-1.91,1.91 -1.91,5.011 -0,6.921l0.01,0.01c1.91,1.91 5.011,1.91 6.921,-0Z" style="fill:#fff;"/></g><g id="beam6" serif:id="beam"><path id="beam7" serif:id="beam" d="M60.676,54.167c-1.907,-1.907 -5.004,-1.907 -6.911,0l-0.02,0.02c-1.907,1.907 -1.907,5.004 0,6.911c1.907,1.907 5.004,1.907 6.911,-0l0.02,-0.02c1.907,-1.907 1.907,-5.004 0,-6.911Z" style="fill:#fff;"/></g><g id="beam8" serif:id="beam"><path id="beam9" serif:id="beam" d="M14.524,34.623c-2.702,0 -4.896,2.194 -4.896,4.896l0,0.01c0,2.702 2.194,4.896 4.896,4.896c2.702,0 4.896,-2.194 4.896,-4.896l0,-0.01c0,-2.702 -2.194,-4.896 -4.896,-4.896Z" style="fill:#fff;"/></g><g id="beam10" serif:id="beam"><path id="beam11" serif:id="beam" d="M44.216,64.534c0,-2.705 -2.196,-4.901 -4.901,-4.901c-2.704,-0 -4.9,2.196 -4.9,4.901c-0,2.704 2.196,4.9 4.9,4.9c2.705,0 4.901,-2.196 4.901,-4.9Z" style="fill:#fff;"/></g><g id="beam12" serif:id="beam"><path id="beam13" serif:id="beam" d="M25.734,17.943c-1.911,-1.911 -5.015,-1.911 -6.926,0l-0.005,0.005c-1.911,1.911 -1.911,5.015 0,6.926c1.911,1.911 5.015,1.911 6.926,0l0.005,-0.005c1.911,-1.911 1.911,-5.014 0,-6.926Z" style="fill:#fff;"/></g><g id="beam14" serif:id="beam"><path id="beam15" serif:id="beam" d="M64.103,34.623c-2.7,0 -4.892,2.192 -4.892,4.892l-0,0.019c-0,2.699 2.192,4.891 4.892,4.891c2.699,0 4.891,-2.192 4.891,-4.891l0,-0.019c0,-2.7 -2.192,-4.892 -4.891,-4.892Z" style="fill:#fff;"/></g></g></g></svg>
    </template>
</a>

<script>
(function() {
    const LOCAL_STORAGE_KEY = 'piccoloThemeMode'

    var initialMode = localStorage.getItem(LOCAL_STORAGE_KEY)

    if (initialMode) {
        // Make sure the value in local storage is valid
        if (['light', 'dark', 'darkest'].indexOf(initialMode) == -1) {
            initialMode = 'light'
            localStorage.setItem(LOCAL_STORAGE_KEY, initialMode)
        }
    } else {
        // Check if the client prefers dark mode
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            initialMode = 'dark'
        } else {
            initialMode = 'light'
        }
        localStorage.setItem(LOCAL_STORAGE_KEY, initialMode)
    }

    document.documentElement.dataset.mode = initialMode

    PetiteVue.createApp({
        'mode': initialMode,
        handleClick() {
            let currentMode = this.mode

            if (currentMode == 'light') {
                this.mode = 'dark'
            } else if (currentMode == 'dark') {
                this.mode = 'darkest'
            } else if (currentMode == 'darkest') {
                this.mode = 'light'
            }

            document.documentElement.dataset.mode = this.mode
            localStorage.setItem(LOCAL_STORAGE_KEY, this.mode)

            console.log(this.mode)
        }
    }).mount('#mode_toggle')
})()
</script>
            <p class="mobile_search_link">
                <a href="search.html" title="Search">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 65 64" fill-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="2">
                        <path d="M14.873 40.009c-2.315-3.943-3.642-8.532-3.642-13.429C11.231 11.91 23.141 0 37.811 0s26.58 11.91 26.58 26.58-11.91 26.58-26.58 26.58a26.44 26.44 0 0 1-14.277-4.161L9.739 62.794a3.12 3.12 0 0 1-4.413 0L.913 58.382c-1.217-1.218-1.217-3.196 0-4.413l13.96-13.96zM37.811 8.054c10.225 0 18.526 8.301 18.526 18.526s-8.301 18.526-18.526 18.526-18.526-8.301-18.526-18.526S27.586 8.054 37.811 8.054z" fill="#fff" />
                    </svg>
                </a>
            </p>
        

        <div class="searchbox_wrapper">
            
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Ricerca veloce</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Vai" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
    </nav>
</div>

    
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper"><p class="caption" role="heading"><span class="caption-text">Indice dei Contenuti</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">1. Introduzione</a></li>
<li class="toctree-l1"><a class="reference internal" href="design.html">2. Principi di design</a></li>
<li class="toctree-l1"><a class="reference internal" href="architecture-overview.html">3. Panoramica dell'Architettura</a></li>
<li class="toctree-l1"><a class="reference internal" href="trust.html">4. L'Infrastruttura di Trust</a></li>
<li class="toctree-l1"><a class="reference internal" href="entities.html">5. Entità</a></li>
<li class="toctree-l1"><a class="reference internal" href="digital-credential-management.html">6. Gestione degli Attestati Elettronici</a></li>
<li class="toctree-l1"><a class="reference internal" href="digital-credential-flows.html">7. Flussi relativi agli Attestati Elettronici</a></li>
<li class="toctree-l1"><a class="reference internal" href="endpoints.html">8. Endpoints</a></li>
<li class="toctree-l1"><a class="reference internal" href="algorithms.html">9. Algoritmi Crittografici</a></li>
<li class="toctree-l1"><a class="reference internal" href="security-privacy-considerations.html">10. Considerazioni di Sicurezza e Privacy</a></li>
<li class="toctree-l1"><a class="reference internal" href="log-retention-policy.html">11. Politiche Generali di Conservazione dei Log</a></li>
<li class="toctree-l1"><a class="reference internal" href="defined-terms-and-references.html">12. Termini Definiti e Riferimenti</a></li>
<li class="toctree-l1"><a class="reference internal" href="contribute.html">13. Come contribuire</a></li>
<li class="toctree-l1"><a class="reference internal" href="open-source.html">14. Rilasci Open Source</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="appendix.html">15. Appendice</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="mobile-application-instance.html">15.1. Istanza dell'Applicazione Mobile</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">15.2. e-Service PDND</a></li>
<li class="toctree-l2"><a class="reference internal" href="test-plans.html">15.3. Piani di Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="appendix-oas-pdnd-issuer.html">15.4. Specifica OpenAPI del Credential Issuer PDND</a></li>
<li class="toctree-l2"><a class="reference internal" href="appendix-oas-pdnd-as.html">15.5. Specifica OpenAPI della Fonte Autentica PDND</a></li>
<li class="toctree-l2"><a class="reference internal" href="appendix-oas-pdnd-wp.html">15.6. Specifica OpenAPI del Fornitore di Wallet PDND</a></li>
</ul>
</li>
</ul>

        </div>
      </div>


    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="e-service-pdnd">
<h1><span class="section-number">15.2. </span>e-Service PDND<a class="headerlink" href="#e-service-pdnd" title="Link to this heading">¶</a></h1>
<p>Il framework <a class="reference external" href="https://github.com/eu-digital-identity-wallet/architecture-and-reference-framework">EIDAS-ARF</a> consente agli Stati Membri di stabilire le interfacce, i termini e le condizioni che regolano la comunicazione tra i Fornitori di Credenziali e le Fonti Autentiche. Nel contesto italiano, l'interoperabilità è stabilita sfruttando le seguenti linee guida:</p>
<blockquote>
<div><ul class="simple">
<li><p>&quot;Linee Guida sull'interoperabilità tecnica delle Pubbliche Amministrazioni&quot; (<a class="reference external" href="https://www.agid.gov.it/sites/agid/files/2024-05/linee_guida_interoperabilit_tecnica_pa.pdf">MODI</a>);</p></li>
<li><p>&quot;Linee Guida sull'infrastruttura tecnologica della Piattaforma Digitale Nazionale Dati per l'interoperabilità dei sistemi informativi e delle basi di dati&quot; (<a class="reference external" href="https://www.agid.gov.it/sites/agid/files/2024-06/Linee_guida_infrastruttura_interoperabilita_pdnd.pdf">PDND</a>).</p></li>
</ul>
</div></blockquote>
<p>Per utilizzare la PDND, le entità DEVONO aderire formalmente, diventando <strong>Aderenti</strong>. All'interno dell'infrastruttura PDND, gli Aderenti DEVONO assumere almeno uno dei seguenti ruoli:</p>
<blockquote>
<div><ul class="simple">
<li><p><strong>Erogatori</strong>: espongono e-Service ad altri Aderenti.</p></li>
<li><p><strong>Fruitori</strong>: utilizzano e-Service offerti dagli Erogatori all'interno dell'Infrastruttura PDND.</p></li>
</ul>
</div></blockquote>
<p>L'accesso ad un e-Service richiede ai Fruitori di ottenere uno specifico Access Token, noto all'interno dell'infrastruttura PDND come Voucher.</p>
<section id="requisiti-e-pattern-di-sicurezza">
<h2><span class="section-number">15.2.1. </span>Requisiti e Pattern di Sicurezza<a class="headerlink" href="#requisiti-e-pattern-di-sicurezza" title="Link to this heading">¶</a></h2>
<p>Questa specifica si basa sul seguente insieme di requisiti:</p>
<table class="longtable docutils align-default">
<colgroup>
<col style="width: 10.0%" />
<col style="width: 70.0%" />
<col style="width: 20.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><strong>ID</strong></p></th>
<th class="head"><p><strong>Descrizione</strong></p></th>
<th class="head"><p><strong>Tipo</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>R1</p></td>
<td><p>Il Fruitore e l'Erogatore hanno entrambi aderito all'infrastruttura PDND.</p></td>
<td><p>Architetturale</p></td>
</tr>
<tr class="row-odd"><td><p>R2</p></td>
<td><p>La comunicazione tra il Fruitore e l'Erogatore DEVE garantire l'integrità dei dati, l'autenticità, la non ripudiabilità e la protezione contro attacchi di replay.</p></td>
<td><p>Sicurezza</p></td>
</tr>
<tr class="row-even"><td><p>R3</p></td>
<td><p>L'Erogatore PUÒ richiedere al Fruitore di includere dati tracciati nella richiesta. In tal caso, DEVE esserci una correlazione tra i dati tracciati e il Voucher.</p></td>
<td><p>Sicurezza</p></td>
</tr>
<tr class="row-odd"><td><p>R4</p></td>
<td><p>Gli e-Service DEVONO essere implementati in REST, quindi il protocollo SOAP NON DEVE essere utilizzato.</p></td>
<td><p>Tecnico</p></td>
</tr>
<tr class="row-even"><td><p>R5</p></td>
<td><p>L'Erogatore DEVE garantire, con un alto grado di certezza, la prova di possesso del Voucher da parte del Fruitore.</p></td>
<td><p>Sicurezza</p></td>
</tr>
</tbody>
</table>
<p><a class="reference external" href="https://www.agid.gov.it/sites/agid/files/2024-06/Linee_guida_infrastruttura_interoperabilita_pdnd.pdf">PDND</a> e <a class="reference external" href="https://www.agid.gov.it/sites/agid/files/2024-05/linee_guida_interoperabilit_tecnica_pa.pdf">MODI</a> definiscono diversi pattern di sicurezza progettati per migliorare specifiche proprietà di sicurezza nelle interazioni tra gli Aderenti. Questa specifica adotta i seguenti pattern di sicurezza:</p>
<table class="longtable docutils align-default">
<colgroup>
<col style="width: 80.0%" />
<col style="width: 20.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><strong>Pattern di Sicurezza</strong></p></th>
<th class="head"><p><strong>Conforme a</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>[REST_JWS_2021_POP]</strong> Profilo di emissione dei Voucher JWS POP (<em>Allegato 3 - Standard e dettagli tecnici utilizzati per la fruizione dei Voucher di autorizzazione</em> [<a class="reference external" href="https://www.agid.gov.it/sites/agid/files/2024-06/Linee_guida_infrastruttura_interoperabilita_pdnd.pdf">PDND</a>]): OBBLIGATORIO. Aggiunge una prova di possesso sul Voucher. Il Fruitore che utilizza il Voucher per accedere a un e-Service DEVE dimostrare la prova di possesso della chiave privata la cui chiave pubblica è attestata nel Voucher.</p></td>
<td><p>R2, R4, R5</p></td>
</tr>
<tr class="row-odd"><td><p><strong>[ID_AUTH_CHANNEL_01]</strong> Direct Trust Transport-Level Security (<em>Allegato 2 - Pattern di sicurezza</em> [<a class="reference external" href="https://www.agid.gov.it/sites/agid/files/2024-05/linee_guida_interoperabilit_tecnica_pa.pdf">MODI</a>]): OBBLIGATORIO. Protegge la comunicazione tra il Fruitore e l'Erogatore garantendo riservatezza, integrità, identificazione dell'Erogatore e mitigazione contro attacchi di replay e spoofing.</p></td>
<td><p>R1, R2</p></td>
</tr>
<tr class="row-even"><td><p><strong>[INTEGRITY_REST_02]</strong> Integrità del payload delle richieste REST in PDND (<em>Allegato 2 - Pattern di sicurezza</em> [<a class="reference external" href="https://www.agid.gov.it/sites/agid/files/2024-05/linee_guida_interoperabilit_tecnica_pa.pdf">MODI</a>]): CONDIZIONALE. Garantisce l'integrità del payload della richiesta REST del Fruitore, all'interno dell'Infrastruttura PDND. È OBBLIGATORIO ogni volta che la richiesta contiene un payload.</p></td>
<td><p>R2, R4</p></td>
</tr>
<tr class="row-odd"><td><p><strong>[AUDIT_REST_02]</strong> Inoltro dati tracciati nel dominio del Fruitore REST con correlazione (<em>Allegato 2 - Pattern di sicurezza</em> [<a class="reference external" href="https://www.agid.gov.it/sites/agid/files/2024-05/linee_guida_interoperabilit_tecnica_pa.pdf">MODI</a>]): OPZIONALE. L'Erogatore PUÒ richiedere dati aggiuntivi tracciati nel dominio del Fruitore, con una correlazione tra tali dati e il metodo di autenticazione. In tal caso, questo pattern DEVE essere utilizzato.</p></td>
<td><p>R3, R4</p></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>In queste specifiche, il pattern di sicurezza <code class="docutils literal notranslate"><span class="pre">REST_JWS_2021_POP</span></code> è implementato di default in conformità con <span class="target" id="index-0"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc9449.html"><strong>RFC 9449</strong></a>. Se DPoP non è supportato dall'Infrastruttura PDND, la prova di possesso è attestata dal JWT <code class="docutils literal notranslate"><span class="pre">TrackingEvidence</span></code> (come dettagliato di seguito). Tuttavia, mentre il <code class="docutils literal notranslate"><span class="pre">TrackingEvidence</span></code> è definito in <code class="docutils literal notranslate"><span class="pre">AUDIT_REST_02</span></code> per fornire dati tracciati aggiuntivi, in questo contesto funge da prova di possesso del Voucher. Tali scelte di implementazione saranno indicate rispettivamente come <code class="docutils literal notranslate"><span class="pre">POP_DPoP</span></code> e <code class="docutils literal notranslate"><span class="pre">POP_TPoP</span></code>.</p>
</div>
<p>Inoltre, questa specifica definisce e applica il seguente pattern di sicurezza personalizzato:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 80.0%" />
<col style="width: 20.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><strong>Pattern di Sicurezza</strong></p></th>
<th class="head"><p><strong>Conforme a</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Integrità del payload delle risposte REST in PDND: OBBLIGATORIO. Garantisce l'integrità del payload della risposta REST dell'Erogatore, all'interno dell'Infrastruttura PDND.</p></td>
<td><p>R2</p></td>
</tr>
</tbody>
</table>
<p>I seguenti pattern di sicurezza definiti in <a class="reference external" href="https://www.agid.gov.it/sites/agid/files/2024-06/Linee_guida_infrastruttura_interoperabilita_pdnd.pdf">PDND</a> e <a class="reference external" href="https://www.agid.gov.it/sites/agid/files/2024-05/linee_guida_interoperabilit_tecnica_pa.pdf">MODI</a> NON DEVONO essere utilizzati in quanto non conformi ai requisiti definiti in precedenza:</p>
<blockquote>
<div><ul class="simple">
<li><p>I seguenti pattern possono essere utilizzati solo quando il Fruitore non può iscriversi all'Infrastruttura PDND (ossia quando la trust tra gli Aderenti deve essere stabilita in forma diretta), pertanto non risultano conformi a <strong>R1</strong>:</p>
<ul>
<li><p><strong>[ID_AUTH_CHANNEL_02]</strong> Direct Trust mutual Transport-Level Security (<em>Allegato 2 - Pattern di Sicurezza</em> [<a class="reference external" href="https://www.agid.gov.it/sites/agid/files/2024-05/linee_guida_interoperabilit_tecnica_pa.pdf">MODI</a>])</p></li>
<li><p><strong>[ID_AUTH_REST_01]</strong> Direct Trust con certificato X.509 su REST (<em>Allegato 2 - Pattern di sicurezza</em> [<a class="reference external" href="https://www.agid.gov.it/sites/agid/files/2024-05/linee_guida_interoperabilit_tecnica_pa.pdf">MODI</a>]).</p></li>
<li><p><strong>[ID_AUTH_REST_02]</strong> Direct Trust con certificato X.509 su REST con unicità del token/messaggio (<em>Allegato 2 - Pattern di sicurezza</em> [<a class="reference external" href="https://www.agid.gov.it/sites/agid/files/2024-05/linee_guida_interoperabilit_tecnica_pa.pdf">MODI</a>]).</p></li>
<li><p><strong>[INTEGRITY_REST_01]</strong> Integrità del payload messaggio REST (<em>Allegato 2 - Pattern di sicurezza</em> [<a class="reference external" href="https://www.agid.gov.it/sites/agid/files/2024-05/linee_guida_interoperabilit_tecnica_pa.pdf">MODI</a>]).</p></li>
</ul>
</li>
<li><p>Il seguente pattern non fornisce correlazione tra i dati tracciati e il Voucher, pertanto non risulta conforme a <strong>R3</strong>:</p>
<ul>
<li><p><strong>[AUDIT_REST_01]</strong> Inoltro dati tracciati nel dominio del Fruitore REST (<em>Allegato 2 - Pattern di sicurezza</em> [<a class="reference external" href="https://www.agid.gov.it/sites/agid/files/2024-05/linee_guida_interoperabilit_tecnica_pa.pdf">MODI</a>]).</p></li>
</ul>
</li>
<li><p>I seguenti pattern sono basati su un'architettura SOAP, pertanto non risultano conformi a <strong>R4</strong>:</p>
<ul>
<li><p><strong>[ID_AUTH_SOAP_01]</strong> Direct Trust con certificato X.509 su SOAP (<em>Allegato 2 - Pattern di sicurezza</em> [<a class="reference external" href="https://www.agid.gov.it/sites/agid/files/2024-05/linee_guida_interoperabilit_tecnica_pa.pdf">MODI</a>]).</p></li>
<li><p><strong>[ID_AUTH_SOAP_02]</strong> Direct Trust con certificato X.509 su SOAP con unicità del token/messaggio (<em>Allegato 2 - Pattern di sicurezza</em> [<a class="reference external" href="https://www.agid.gov.it/sites/agid/files/2024-05/linee_guida_interoperabilit_tecnica_pa.pdf">MODI</a>]).</p></li>
<li><p><strong>[INTEGRITY_SOAP_01]</strong> Integrità del payload del messaggio SOAP (<em>Allegato 2 - Pattern di sicurezza</em> [<a class="reference external" href="https://www.agid.gov.it/sites/agid/files/2024-05/linee_guida_interoperabilit_tecnica_pa.pdf">MODI</a>]).</p></li>
</ul>
</li>
<li><p>Il seguente pattern non garantisce la prova di possesso del Voucher, pertanto non risulta conforme a <strong>R5</strong>:</p>
<ul>
<li><p><strong>[REST_JWS_2021_Bearer]</strong> Profilo di emissione dei Voucher JWS Bearer (<em>Allegato 3 - Standard e dettagli tecnici utilizzati per la fruizione dei Voucher di autorizzazione</em> [<a class="reference external" href="https://www.agid.gov.it/sites/agid/files/2024-06/Linee_guida_infrastruttura_interoperabilita_pdnd.pdf">PDND</a>]).</p></li>
</ul>
</li>
</ul>
</div></blockquote>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Nel caso di implementazione <code class="docutils literal notranslate"><span class="pre">POP_TPoP</span></code>, il Voucher viene emesso come token Bearer. Tuttavia, poiché è accompagnato da una prova di possesso, è comunque conforme al pattern di sicurezza <code class="docutils literal notranslate"><span class="pre">REST_JWS_2021_POP</span></code> invece che <code class="docutils literal notranslate"><span class="pre">REST_JWS_2021_Bearer</span></code>.</p>
</div>
</section>
<section id="emissione-del-voucher-pdnd">
<h2><span class="section-number">15.2.2. </span>Emissione del Voucher PDND<a class="headerlink" href="#emissione-del-voucher-pdnd" title="Link to this heading">¶</a></h2>
<p>L'Infrastruttura PDND definisce due diversi tipi di Voucher:</p>
<blockquote>
<div><ul class="simple">
<li><p><strong>Per e-Service</strong>: consentono ai Fruitori di richiedere dati da un e-Service.</p></li>
<li><p><strong>Per API di Interoperabilità</strong>: consentono agli Aderenti di richiedere dati dall'API di Interoperabilità, esposta dall'Infrastruttura PDND.</p></li>
</ul>
</div></blockquote>
<p>I due flussi sono descritti di seguito.</p>
<section id="voucher-pdnd-per-e-service">
<h3><span class="section-number">15.2.2.1. </span>Voucher PDND per e-Service<a class="headerlink" href="#voucher-pdnd-per-e-service" title="Link to this heading">¶</a></h3>
<section id="prerequisiti-per-il-voucher-pdnd-per-e-service">
<h4><span class="section-number">15.2.2.1.1. </span>Prerequisiti per il Voucher PDND per e-Service<a class="headerlink" href="#prerequisiti-per-il-voucher-pdnd-per-e-service" title="Link to this heading">¶</a></h4>
<p>Il <strong>Fruitore</strong> DEVE rispettare i seguenti prerequisiti:</p>
<blockquote>
<div><ul class="simple">
<li><p>Ha completato con successo l'adesione all'Infrastruttura PDND (come da R1).</p></li>
<li><p>Ha creato un nuovo <cite>Client e-service</cite> per interagire con l'e-Service desiderato. Al momento della creazione, gli è stato assegnato un <code class="docutils literal notranslate"><span class="pre">client_id</span></code> dalla Piattaforma PDND.</p></li>
<li><p>Ha registrato una coppia di chiavi associata al <cite>Client e-service</cite>.</p></li>
<li><p>Ha richiesto di iscriversi all'e-Service desiderato.</p></li>
<li><p>Ha definito un nuovo scopo per l'e-Service. Al momento della definizione, gli è stato assegnato un <code class="docutils literal notranslate"><span class="pre">purposeId</span></code> dalla Piattaforma PDND.</p></li>
<li><p>Ha associato il <cite>Client e-service</cite> allo scopo definito.</p></li>
</ul>
</div></blockquote>
<p>L'<strong>Erogatore</strong> DEVE rispettare i seguenti prerequisiti:</p>
<blockquote>
<div><ul class="simple">
<li><p>Ha completato con successo l'adesione all'Infrastruttura PDND (come da R1).</p></li>
<li><p>Ha creato un nuovo e-Service e lo ha pubblicato all'interno del Catalogo API PDND.</p></li>
<li><p>Ha approvato la richiesta del Fruitore di iscriversi all'e-Service.</p></li>
</ul>
</div></blockquote>
</section>
<section id="flusso-del-voucher-pdnd-per-e-service">
<h4><span class="section-number">15.2.2.1.2. </span>Flusso del Voucher PDND per e-Service<a class="headerlink" href="#flusso-del-voucher-pdnd-per-e-service" title="Link to this heading">¶</a></h4>
<figure class="align-default" id="id1">
<span id="fig-voucherissuance-eservice-flow"></span><p class="plantuml">
<object data="_images/plantuml-f84783ca28e7757e5f8ab75faa1f0db10b3846c6.svg" type="image/svg+xml" style="width:80%">
<a href="_images/plantuml-f84783ca28e7757e5f8ab75faa1f0db10b3846c6.png"><img src="_images/plantuml-f84783ca28e7757e5f8ab75faa1f0db10b3846c6.png" alt="La figura illustra l'emissione del Voucher per e-Service - Flusso dettagliato." style="width: 80.0%"/></a>

</object></p>
<figcaption>
<p><span class="caption-number">Fig. 15.2 </span><span class="caption-text"><a class="reference external" href="https://www.plantuml.com/plantuml/svg/VP71RjH0343lynLMUcaZLaALuD03QfHjrKK8ecQ1O-HEtCqeoJXuF4ktNqycj5s42fSeTkpdP-SoA8h6SO1l76r70fiG8dfBi09QrIHxPycequ7-Ns8mAliutf4OSySFaESb-n17aZo7aysUvM009XHrrate5R8y_r94xQ0S77dDymmmG7bjoBSm8vuvrVhpEZ6AnoZqBqPwiBX7LCSUaXN94x6eZqIU5AvPeFYwtcoRswjwsxmzDp1FNNqehoygePbEyF7x5dww6Mjvd0OQoIlA0LfKXDCismhQtldTrTwrv2rbsPavGigv9of1VLESltiF7OOE-1vUQqkmczE_ysU9DoiRyqmKGYLOLrn1JmUOq0cWRs4IvlkbggWlNdxGBVs853J1xNBQnhLPzWPUGWo191tgzMoZXub-Vze9UbtYPKVnh0Iy9u6YXfDFRjTfvNoVbk_8zY5fBqN65FLgaJzQXObzeAI5rb88ZN9FJmxfzS_1z30veT0udmPVpjWu3hy0">Emissione del Voucher per e-Service - Flusso dettagliato.</a></span><a class="headerlink" href="#id1" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<p><strong>Passi 1-2 (Preparazione dei dati tracciati):</strong> Il Fruitore prepara un JWT (<code class="docutils literal notranslate"><span class="pre">TrackingEvidence</span></code>) contenente i dati tracciati che devono essere inviati all'Erogatore. Infine, calcola l'hash SHA-256 di <code class="docutils literal notranslate"><span class="pre">TrackingEvidence</span></code>.</p>
<div class="literal-block-wrapper docutils container" id="code-voucherissuance-eservice-flow-trackingevidence-header">
<div class="code-block-caption"><span class="caption-number">Listato 15.1 </span><span class="caption-text">Esempio non normativo dell'header di <code class="docutils literal notranslate"><span class="pre">TrackingEvidence</span></code></span><a class="headerlink" href="#code-voucherissuance-eservice-flow-trackingevidence-header" title="Link to this code">¶</a></div>
<div class="highlight-Json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;alg&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ES256&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;kid&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;d4c3b2a1-9876-5432-10fe-dcba98765432&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;typ&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;JWT&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="code-voucherissuance-eservice-flow-trackingevidence-payload">
<div class="code-block-caption"><span class="caption-number">Listato 15.2 </span><span class="caption-text">Esempio non normativo del payload di <code class="docutils literal notranslate"><span class="pre">TrackingEvidence</span></code></span><a class="headerlink" href="#code-voucherissuance-eservice-flow-trackingevidence-payload" title="Link to this code">¶</a></div>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;iss&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;82914b3f-60b2-4529-b4d6-3d4e67f0a933&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;aud&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://erogatore.example/ente-example/v1&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;exp&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1733052600</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;nbf&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1733036450</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;iat&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1733036400</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;jti&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;a4b5c6d7-e8f9-abcd-ef12-345678901234&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;dnonce&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">6528424213685</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;purposeId&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;b2c3d4e5-f6g7-h8i9-j0k1-lmno12345678&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;userID&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;a8b7c6d5-e4f3-g2h1-i9j0-klmnopqrstuv&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;loa&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;substantial&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>I passi 1-2 sono richiesti solo quando si rispetta il pattern di sicurezza <code class="docutils literal notranslate"><span class="pre">AUDIT_REST_02</span></code> o l'implementazione <code class="docutils literal notranslate"><span class="pre">POP_TPoP</span></code>.</p>
</div>
<p><strong>Passo 3 (Generazione coppia di chiavi e `DPoP proof`)</strong>: Il Fruitore DEVE creare una nuova coppia di chiavi e un nuovo JWT di <cite>DPoP proof</cite>, seguendo le istruzioni fornite nella Sezione 4 di <span class="target" id="index-1"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc9449.html"><strong>RFC 9449</strong></a> per la richiesta di token all'Authorization Server PDND.</p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Il passo 3 è richiesto solo quando si segue l'implementazione <code class="docutils literal notranslate"><span class="pre">POP_DPoP</span></code>.</p>
</div>
<p><strong>Passo 4 (Richiesta di Voucher)</strong>: Il Fruitore crea una <cite>Voucher Request</cite> e la invia all'Authorization Server PDND.</p>
<div class="literal-block-wrapper docutils container" id="code-voucherissuance-eservice-flow-request">
<div class="code-block-caption"><span class="caption-number">Listato 15.3 </span><span class="caption-text">Esempio non normativo della <cite>Voucher Request</cite></span><a class="headerlink" href="#code-voucherissuance-eservice-flow-request" title="Link to this code">¶</a></div>
<div class="highlight-http notranslate"><div class="highlight"><pre><span></span><span class="nf">POST</span> <span class="nn">/authorization-server/token</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">interop.pagopa.it</span>
<span class="na">DPoP</span><span class="o">:</span> <span class="l">eyJ0eXAiOiJkcG9wK2p3dCIsImFsZyI6IkVTMjU2IiwiandrIjp7Imt0eSI6IkVDIiwia2V5X29wcyI6WyJzaWduIl0sImtpZCI6IjM5ZmE5NjBiLTc3M2YtNDllZi04YTBlLWU3NzNlOWI5N2FlOCIsImNydiI6IlAtMjU2IiwieCI6Imh1eVhJUU52OTAyb0xzcFg0X3pvbkM5NEc2eUVsbjZsc2RtLTF3TTczMm8iLCJ5IjoiSTlQREVhd1dIcWFGREd4MVprTmstMlBWNldkcGNhSDNBZk9iQlNMaWhndyJ9fQ.eyJqdGkiOiI1NTBlODQwMC1lMjliLTQxZDQtYTcxNi00NDY2NTU0NDAwMDAiLCJodG0iOiJQT1NUIiwiaHR1IjoiaHR0cHM6Ly9pbnRlcm9wLnBhZ29wYS5pdC9hdXRob3JpemF0aW9uLXNlcnZlciIsImlhdCI6MTc2MjI2MDYxNn0.D0ZUDkfGHx_rQBdYi_3VSXkdbJM-7FSWN88LWICQImMWtIWd2mbxGb7v8udfM_c4_ase8x7I3I1JZm01Us3QEA</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/x-www-form-urlencoded</span>

<span class="nt">grant_type</span><span class="o">=</span><span class="s">client_credentials</span><span class="p">&amp;</span>
<span class="nt">client_id</span><span class="o">=</span><span class="s">82914b3f-60b2-4529-b4d6-3d4e67f0a933</span><span class="p">&amp;</span>
<span class="nt">client_assertion_type</span><span class="o">=</span><span class="s">urn%3Aietf%3Aparams%3Aoauth%3Aclient-assertion-type%3Ajwt-bearer</span><span class="p">&amp;</span>
<span class="nt">client_assertion</span><span class="o">=</span><span class="s">eyJhbGciOiJFUzI1NiIsImtpZCI6ImQ0YzNiMmExLTk4NzYtNTQzMi0xMGZlLWRjYmE5ODc2NTQzMiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiI4MjkxNGIzZi02MGIyLTQ1MjktYjRkNi0zZDRlNjdmMGE5MzMiLCJzdWIiOiI4MjkxNGIzZi02MGIyLTQ1MjktYjRkNi0zZDRlNjdmMGE5MzMiLCJhdWQiOiJpbnRlcm9wLnBhZ29wYS5pdC9hdXRob3JpemF0aW9uLXNlcnZlciIsImV4cCI6MTczMzA0MTQ0MCwiaWF0IjoxNzMzMDM3ODQwLCJqdGkiOiI3ZTlmM2E0ZC1jOWIyLTQyZjYtYTZkNC0zOGUxMmZiNmI4YWIiLCJwdXJwb3NlSWQiOiJkMmI5YTY1My1jNDk3LTQ1YzYtYjhmMS01YmRmMTI0YzlkM2EiLCJkaWdlc3QiOnsiYWxnIjoiU0hBMjU2IiwidmFsdWUiOiI5Yzc4OTRhMGE1YTkxMDU4MGI5NjdmMzg0Y2RmYmExN2IxYWI2Zjg2NjcwZTViMGRmMThhMGM0NTNiNWViMjE1In19.cl-wvwJF3WLgywoq9qULVKCajleqz0jpD82QTZZAxHSjoGeA7l7n0LNC8eDfIM4F-rzMU5qfC9eW6UDxMwJrdg</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="code-voucherissuance-eservice-flow-clientassertion-header">
<div class="code-block-caption"><span class="caption-number">Listato 15.4 </span><span class="caption-text">Esempio non normativo del JOSE header di <code class="docutils literal notranslate"><span class="pre">client_assertion</span></code></span><a class="headerlink" href="#code-voucherissuance-eservice-flow-clientassertion-header" title="Link to this code">¶</a></div>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;alg&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ES256&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;kid&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;d4c3b2a1-9876-5432-10fe-dcba98765432&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;typ&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;JWT&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="code-voucherissuance-eservice-flow-clientassertion-payload">
<div class="code-block-caption"><span class="caption-number">Listato 15.5 </span><span class="caption-text">Esempio non normativo del payload di <code class="docutils literal notranslate"><span class="pre">client_assertion</span></code></span><a class="headerlink" href="#code-voucherissuance-eservice-flow-clientassertion-payload" title="Link to this code">¶</a></div>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;iss&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;82914b3f-60b2-4529-b4d6-3d4e67f0a933&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;sub&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;82914b3f-60b2-4529-b4d6-3d4e67f0a933&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;aud&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://interop.pagopa.it/authorization-server&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;exp&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1733041440</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;iat&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1733037840</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;jti&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;7e9f3a4d-c9b2-42f6-a6d4-38e12fb6b8ab&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;purposeId&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;d2b9a653-c497-45c6-b8f1-5bdf124c9d3a&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;digest&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;alg&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;SHA256&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;9c7894a0a5a910580b967f384cdfba17b1ab6f86670e5b0df18a0c453b5eb215&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Il claim <code class="docutils literal notranslate"><span class="pre">purposeId</span></code> nel payload di <code class="docutils literal notranslate"><span class="pre">client_assertion</span></code> è richiesto solo quando si richiede un Voucher per e-Service.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Il claim <code class="docutils literal notranslate"><span class="pre">digest</span></code> nel payload di <code class="docutils literal notranslate"><span class="pre">client_assertion</span></code> è richiesto solo quando si rispetta il pattern di sicurezza <code class="docutils literal notranslate"><span class="pre">AUDIT_REST_02</span></code> o l'implementazione <code class="docutils literal notranslate"><span class="pre">POP_TPoP</span></code>.</p>
</div>
<p>Alla ricezione della <cite>Voucher Request</cite>, l'Authorization Server PDND DEVE eseguire i seguenti controlli sui parametri del relativo body:</p>
<blockquote>
<div><ul class="simple">
<li><p>Il claim <code class="docutils literal notranslate"><span class="pre">client_assertion_type</span></code> è impostato su <code class="docutils literal notranslate"><span class="pre">urn:ietf:params:oauth:client-assertion-type:jwt-bearer</span></code>.</p></li>
<li><p>Il claim <code class="docutils literal notranslate"><span class="pre">grant_type</span></code> è impostato su <code class="docutils literal notranslate"><span class="pre">client_credentials</span></code>.</p></li>
</ul>
</div></blockquote>
<p>L'Authorization Server PDND DEVE anche validare il JWT <code class="docutils literal notranslate"><span class="pre">client_assertion</span></code> come segue:</p>
<blockquote>
<div><p>Header:</p>
<blockquote>
<div><ul class="simple">
<li><p>Assicurarsi che il claim <code class="docutils literal notranslate"><span class="pre">typ</span></code> sia presente e che il suo valore sia <code class="docutils literal notranslate"><span class="pre">JWT</span></code>.</p></li>
</ul>
</div></blockquote>
<p>Firma:</p>
<blockquote>
<div><ul class="simple">
<li><p>Ottenere la chiave pubblica del Fruitore corrispondente al parametro header <code class="docutils literal notranslate"><span class="pre">kid</span></code>, interagendo con l'API di Interoperabilità PDND.</p></li>
<li><p>Validare la firma del JWT utilizzando la chiave pubblica del Fruitore recuperata e l'algoritmo specificato dal parametro header <code class="docutils literal notranslate"><span class="pre">alg</span></code>.</p></li>
</ul>
</div></blockquote>
<p>Payload:</p>
<blockquote>
<div><ul class="simple">
<li><p>I claim <code class="docutils literal notranslate"><span class="pre">iss</span></code> e <code class="docutils literal notranslate"><span class="pre">sub</span></code> DEVONO identificare un Client registrato nell'Infrastruttura PDND.</p></li>
<li><p>Il claim <code class="docutils literal notranslate"><span class="pre">aud</span></code> DEVE rappresentare l'Authorization Server PDND.</p></li>
<li><p>Il claim <code class="docutils literal notranslate"><span class="pre">exp</span></code> DEVE rappresentare un istante temporale successivo all'ora corrente.</p></li>
<li><p>Se il claim <code class="docutils literal notranslate"><span class="pre">nbf</span></code> è presente, DEVE rappresentare un istante temporale precedente all'ora corrente.</p></li>
<li><p>Il claim <code class="docutils literal notranslate"><span class="pre">iat</span></code> DEVE rappresentare un istante temporale precedente all'ora corrente.</p></li>
<li><p>Il claim <code class="docutils literal notranslate"><span class="pre">jti</span></code> NON DEVE essere stato utilizzato in precedenza.</p></li>
<li><p>Il claim <code class="docutils literal notranslate"><span class="pre">purposeId</span></code> DEVE identificare uno scopo registrato nell'Infrastruttura PDND e associato al Client.</p></li>
</ul>
</div></blockquote>
</div></blockquote>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>L'Authorization Server PDND non deve eseguire alcun controllo sul claim <code class="docutils literal notranslate"><span class="pre">digest</span></code>.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>La verifica dei claim <code class="docutils literal notranslate"><span class="pre">exp</span></code>, <code class="docutils literal notranslate"><span class="pre">nbf</span></code>, <code class="docutils literal notranslate"><span class="pre">iat</span></code> e <code class="docutils literal notranslate"><span class="pre">jti</span></code>, come dettagliato sopra, DEVE essere eseguita per tutti i JWT descritti in questa sezione. Questi controlli non saranno esplicitamente menzionati nei riferimenti successivi.</p>
</div>
<p><strong>Passo 6 (Emissione del Voucher)</strong>: Qualora i controlli abbiano successo, l'Authorization Server PDND emette un Voucher, che è incluso nella <cite>Voucher Response</cite> inviata al Fruitore.</p>
<div class="literal-block-wrapper docutils container" id="code-voucherissuance-eservice-flow-response">
<div class="code-block-caption"><span class="caption-number">Listato 15.6 </span><span class="caption-text">Esempio non normativo della <cite>Voucher Response</cite></span><a class="headerlink" href="#code-voucherissuance-eservice-flow-response" title="Link to this code">¶</a></div>
<div class="highlight-http notranslate"><div class="highlight"><pre><span></span><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">no-store</span>

<span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;access_token&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;eyJhbGciOiJFUzI1NiIsImtpZCI6ImI4MzlmNGM3LTFlNWQtNGE4YS05ZmM2LTcyZDNiN2YwOTFlYyIsInR5cCI6ImF0K2p3dCJ9.eyJpc3MiOiJpbnRlcm9wLnBhZ29wYS5pdCIsInN1YiI6IjgyOTE0YjNmLTYwYjItNDUyOS1iNGQ2LTNkNGU2N2YwYTkzMyIsImF1ZCI6Imh0dHBzOi8vZXJvZ2F0b3JlLmV4YW1wbGUvZW50ZS1leGFtcGxlL3YxIiwiZXhwIjoxNzMzMDQyMTUwLCJuYmYiOjE3MzMwNDE5NDUsImlhdCI6MTczMzA0MTkyMCwianRpIjoiYzRmNWQ3ZTItYjdjOC00MGY2LTliNmEtZGM5YTRmNWFlYjU3IiwiY2xpZW50X2lkIjoiODI5MTRiM2YtNjBiMi00NTI5LWI0ZDYtM2Q0ZTY3ZjBhOTMzIiwicHVycG9zZUlkIjoiZDJiOWE2NTMtYzQ5Ny00NWM2LWI4ZjEtNWJkZjEyNGM5ZDNhIiwiZGlnZXN0Ijp7ImFsZyI6IlNIQTI1NiIsInZhbHVlIjoiOTkwOGQ5NGI4ZmViMjY4YzAzNzEwNmQ3Yzg5ZTcwNjBjMmNjMWY2YjJiNGViY2I4MDViZmVlNTNhNTM5MzA3YiJ9LCJjbmYiOnsiamt0IjoiMFpjT0NPUlpOWXktRFdwcXEzMGpaeUpHSFROMGQySGdsQlYzdWlndUE0SSJ9fQ.sGhaHEOfMTB7r4_8ZILM_a9eTBGawWn3kL-dxYoZggFIzyrXDOZcQWt0zr00lMk2iYAMWxS32e4cUedmAsBXGw&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;token_type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;DPoP&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;expires_in&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">3600</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="code-voucherissuance-eservice-flow-accesstoken-header">
<div class="code-block-caption"><span class="caption-number">Listato 15.7 </span><span class="caption-text">Esempio non normativo del JOSE header di <code class="docutils literal notranslate"><span class="pre">access_token</span></code></span><a class="headerlink" href="#code-voucherissuance-eservice-flow-accesstoken-header" title="Link to this code">¶</a></div>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;alg&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ES256&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;kid&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;b839f4c7-1e5d-4a8a-9fc6-72d3b7f091ec&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;typ&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;at+jwt&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="code-voucherissuance-eservice-flow-accesstoken-payload">
<div class="code-block-caption"><span class="caption-number">Listato 15.8 </span><span class="caption-text">Esempio non normativo del payload di <code class="docutils literal notranslate"><span class="pre">access_token</span></code></span><a class="headerlink" href="#code-voucherissuance-eservice-flow-accesstoken-payload" title="Link to this code">¶</a></div>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;iss&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://interop.pagopa.it&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;sub&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;82914b3f-60b2-4529-b4d6-3d4e67f0a933&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;aud&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://erogatore.example/ente-example/v1&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;exp&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1733042150</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;nbf&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1733041945</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;iat&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1733041920</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;jti&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;c4f5d7e2-b7c8-40f6-9b6a-dc9a4f5aeb57&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;client_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;82914b3f-60b2-4529-b4d6-3d4e67f0a933&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;purposeId&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;d2b9a653-c497-45c6-b8f1-5bdf124c9d3a&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;digest&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;alg&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;SHA256&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;9c7894a0a5a910580b967f384cdfba17b1ab6f86670e5b0df18a0c453b5eb215&quot;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;cnf&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;jkt&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;0ZcOCORZNYy-DWpqq30jZyJGHTN0d2HglBV3uiguA4I&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Il claim <code class="docutils literal notranslate"><span class="pre">digest</span></code> nel payload di <code class="docutils literal notranslate"><span class="pre">access_token</span></code> è richiesto solo quando si rispetta il pattern di sicurezza <code class="docutils literal notranslate"><span class="pre">AUDIT_REST_02</span></code> o l'implementazione <code class="docutils literal notranslate"><span class="pre">POP_TPoP</span></code>. Se presente, corrisponde al valore del claim <code class="docutils literal notranslate"><span class="pre">digest</span></code> contenuto in <code class="docutils literal notranslate"><span class="pre">client_assertion</span></code>.</p>
</div>
</section>
</section>
<section id="voucher-pdnd-per-api-di-interoperabilita">
<h3><span class="section-number">15.2.2.2. </span>Voucher PDND per API di Interoperabilità<a class="headerlink" href="#voucher-pdnd-per-api-di-interoperabilita" title="Link to this heading">¶</a></h3>
<section id="prerequisiti-per-il-voucher-pdnd-per-api-di-interoperabilita">
<h4><span class="section-number">15.2.2.2.1. </span>Prerequisiti per il Voucher PDND per API di Interoperabilità<a class="headerlink" href="#prerequisiti-per-il-voucher-pdnd-per-api-di-interoperabilita" title="Link to this heading">¶</a></h4>
<p>L'<strong>Aderente</strong> DEVE rispettare i seguenti prerequisiti:</p>
<blockquote>
<div><ul class="simple">
<li><p>Ha completato con successo l'adesione all'Infrastruttura PDND.</p></li>
<li><p>Ha creato un nuovo <cite>Client interop api</cite> per interagire con l'API di Interoperabilità. Al momento della creazione, gli è stato assegnato un <code class="docutils literal notranslate"><span class="pre">client_id</span></code> dalla Piattaforma PDND.</p></li>
<li><p>Ha registrato una coppia di chiavi associata al <cite>Client interop api</cite>.</p></li>
</ul>
</div></blockquote>
</section>
<section id="flusso-del-voucher-per-api-di-interoperabilita">
<h4><span class="section-number">15.2.2.2.2. </span>Flusso del Voucher per API di Interoperabilità<a class="headerlink" href="#flusso-del-voucher-per-api-di-interoperabilita" title="Link to this heading">¶</a></h4>
<figure class="align-default" id="id2">
<span id="fig-voucherissuance-interoperabilityapi-flow"></span><p class="plantuml">
<object data="_images/plantuml-2fc5da499a7427e9451a516e6d5240613f29845f.svg" type="image/svg+xml" style="width:80%">
<a href="_images/plantuml-2fc5da499a7427e9451a516e6d5240613f29845f.png"><img src="_images/plantuml-2fc5da499a7427e9451a516e6d5240613f29845f.png" alt="La figura illustra l'emissione del Voucher per API di Interoperabilità - Flusso dettagliato." style="width: 80.0%"/></a>

</object></p>
<figcaption>
<p><span class="caption-number">Fig. 15.3 </span><span class="caption-text"><a class="reference external" href="https://www.plantuml.com/plantuml/svg/ZP11ozf048Rl-ok6UD7GqFOg4WmH8L3Qq41FXR0cWrbCTjEPsQ3--heQr4CBtoLavXsUzs6tB9h43ptyShxfaA1Wzjes20aKLf3SYAGFfZToWQmib1ZfySFNIdjnrWy79AKExWnH79UQn3Hcr5RY-BVTiBdY-kkNT9axotv00aURps6RlgKbkScqIAivYc1HJ8uk2c1y0GF_H-QbWxmt60eYq0pvNg5juIRmiBX9xBxluXWMsTKJ_eyHFexCLOjn5Yga2MacPjMBcE-JDAlMpqVvYNyyii0oYfgxHMtQAFe4pr4p8mNclxUrN4PyH4VILkPvfHHP9mXkGhe9mEARENPI6djI07c7pOc3rFr8gQnAaZJVhrzMF3hB6BHqqo1pBUw4iqFuVI_6ysW8kJOs56_Hjdxe_m80">Emissione del Voucher per API di Interoperabilità - Flusso dettagliato.</a></span><a class="headerlink" href="#id2" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<p><strong>Passo 1 (Richiesta di Voucher)</strong>: L'Aderente crea una <cite>Voucher Request</cite> e la invia all'Authorization Server PDND.</p>
<div class="literal-block-wrapper docutils container" id="code-voucherissuance-interoperabilityapi-flow-request">
<div class="code-block-caption"><span class="caption-number">Listato 15.9 </span><span class="caption-text">Esempio non normativo della <cite>Voucher Request</cite></span><a class="headerlink" href="#code-voucherissuance-interoperabilityapi-flow-request" title="Link to this code">¶</a></div>
<div class="highlight-http notranslate"><div class="highlight"><pre><span></span><span class="nf">POST</span> <span class="nn">/authorization-server/token</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">interop.pagopa.it</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/x-www-form-urlencoded</span>

<span class="nt">grant_type</span><span class="o">=</span><span class="s">client_credentials</span><span class="p">&amp;</span>
<span class="nt">client_id</span><span class="o">=</span><span class="s">5a3c7f28-91b9-4c4e-89a9-6e2f85d9262b</span><span class="p">&amp;</span>
<span class="nt">client_assertion_type</span><span class="o">=</span><span class="s">urn%3Aietf%3Aparams%3Aoauth%3Aclient-assertion-type%3Ajwt-bearer</span><span class="p">&amp;</span>
<span class="nt">client_assertion</span><span class="o">=</span><span class="s">eyJhbGciOiJFUzI1NiIsImtpZCI6IjlhNGQ4ZTNmLThiN2QtNGM5OC05MjZmLTI3NDVjNmIxZjgzMiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiI1YTNjN2YyOC05MWI5LTRjNGUtODlhOS02ZTJmODVkOTI2MmIiLCJzdWIiOiI1YTNjN2YyOC05MWI5LTRjNGUtODlhOS02ZTJmODVkOTI2MmIiLCJhdWQiOiJpbnRlcm9wLnBhZ29wYS5pdC9hdXRob3JpemF0aW9uLXNlcnZlciIsImV4cCI6MTczMzIzMzUwMCwiaWF0IjoxNzMzMjMyMzAwLCJqdGkiOiJkMmM5YTdiNC0zZTgxLTRkMjctYjZmNy01MWE4YzlmMGEzYzYifQ.YDX7ekvvY3gPHTfZeqa3IcurU7kNBZPy3OHAdljdXSFLoC5cVVyIzl43aMbwLouI43ylxWktaf0-pXabmye1qA</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="code-voucherissuance-interoperabilityapi-flow-clientassertion-header">
<div class="code-block-caption"><span class="caption-number">Listato 15.10 </span><span class="caption-text">Esempio non normativo del JOSE header di <code class="docutils literal notranslate"><span class="pre">client_assertion</span></code></span><a class="headerlink" href="#code-voucherissuance-interoperabilityapi-flow-clientassertion-header" title="Link to this code">¶</a></div>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;alg&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ES256&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;kid&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;9a4d8e3f-8b7d-4c98-926f-2745c6b1f832&quot;</span><span class="p">,</span>
<span class="w">     </span><span class="nt">&quot;typ&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;JWT&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="code-voucherissuance-interoperabilityapi-flow-clientassertion-payload">
<div class="code-block-caption"><span class="caption-number">Listato 15.11 </span><span class="caption-text">Esempio non normativo del payload di <code class="docutils literal notranslate"><span class="pre">client_assertion</span></code></span><a class="headerlink" href="#code-voucherissuance-interoperabilityapi-flow-clientassertion-payload" title="Link to this code">¶</a></div>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;iss&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;5a3c7f28-91b9-4c4e-89a9-6e2f85d9262b&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;sub&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;5a3c7f28-91b9-4c4e-89a9-6e2f85d9262b&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;aud&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://interop.pagopa.it/authorization-server&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;exp&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1733233500</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;iat&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1733232300</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;jti&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;d2c9a7b4-3e81-4d27-b6f7-51a8c9f0a3c6&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p>Alla ricezione della <cite>Voucher Request</cite>, l'Authorization Server PDND DEVE eseguire i seguenti controlli sui parametri del relativo body:</p>
<blockquote>
<div><ul class="simple">
<li><p>Il claim <code class="docutils literal notranslate"><span class="pre">client_assertion_type</span></code> è impostato su <code class="docutils literal notranslate"><span class="pre">urn:ietf:params:oauth:client-assertion-type:jwt-bearer</span></code>.</p></li>
<li><p>Il claim <code class="docutils literal notranslate"><span class="pre">grant_type</span></code> è impostato su <code class="docutils literal notranslate"><span class="pre">client_credentials</span></code>.</p></li>
</ul>
</div></blockquote>
<p>L'Authorization Server PDND DEVE anche validare il JWT <code class="docutils literal notranslate"><span class="pre">client_assertion</span></code> come segue:</p>
<blockquote>
<div><p>Header:</p>
<ul class="simple">
<li><p>Assicurarsi che il claim <code class="docutils literal notranslate"><span class="pre">typ</span></code> sia presente e che il suo valore sia <code class="docutils literal notranslate"><span class="pre">JWT</span></code>.</p></li>
</ul>
<p>Firma:</p>
<ul class="simple">
<li><p>Ottenere la chiave pubblica dell'Aderente corrispondente al parametro header <code class="docutils literal notranslate"><span class="pre">kid</span></code>, interagendo con l'API di Interoperabilità PDND.</p></li>
<li><p>Validare la firma del JWT utilizzando la chiave pubblica dell'Aderente recuperata e l'algoritmo specificato dal parametro header <code class="docutils literal notranslate"><span class="pre">alg</span></code>.</p></li>
</ul>
<p>Payload:</p>
<ul class="simple">
<li><p>I claim <code class="docutils literal notranslate"><span class="pre">iss</span></code> e <code class="docutils literal notranslate"><span class="pre">sub</span></code> DEVONO identificare un Client registrato nell'Infrastruttura PDND.</p></li>
<li><p>Il claim <code class="docutils literal notranslate"><span class="pre">aud</span></code> DEVE rappresentare l'Authorization Server PDND.</p></li>
</ul>
</div></blockquote>
<p><strong>Passo 2 (Emissione del Voucher)</strong>: Qualora i controlli abbiano successo, l'Authorization Server PDND emette un Voucher, che è incluso nella <cite>Voucher Response</cite> inviata all'Aderente.</p>
<div class="literal-block-wrapper docutils container" id="code-voucherissuance-interoperabilityapi-flow-response">
<div class="code-block-caption"><span class="caption-number">Listato 15.12 </span><span class="caption-text">Esempio non normativo della <cite>Voucher Response</cite></span><a class="headerlink" href="#code-voucherissuance-interoperabilityapi-flow-response" title="Link to this code">¶</a></div>
<div class="highlight-http notranslate"><div class="highlight"><pre><span></span><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">no-store</span>

<span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;access_token&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;eyJhbGciOiJFUzI1NiIsImtpZCI6ImI4MzlmNGM3LTFlNWQtNGE4YS05ZmM2LTcyZDNiN2YwOTFlYyIsInR5cCI6ImF0K2p3dCJ9.eyJpc3MiOiJpbnRlcm9wLnBhZ29wYS5pdCIsInN1YiI6IjVhM2M3ZjI4LTkxYjktNGM0ZS04OWE5LTZlMmY4NWQ5MjYyYiIsImF1ZCI6Imh0dHBzOi8vaW50ZXJvcC5wYWdvcGEuaXQvYXBpL3YxIiwiZXhwIjoxNzMzMjM2NjgwLCJuYmYiOjE3MzMyMzMxNTgsImlhdCI6MTczMzIzMzA4MCwianRpIjoiZjg3ZTJkNWItOWY2NS00ZjBmLThhZDQtOTJlNThlNmIxM2M3IiwiY2xpZW50X2lkIjoiNWEzYzdmMjgtOTFiOS00YzRlLTg5YTktNmUyZjg1ZDkyNjJiIn0.SKDDap16Ubi6gYwpKVdBcuhmhF_XnGiHeoxkF8F4IAualYORu_TxnDZqeP_RCcBAxSRkJTFbMihPCLA7DoRQOw&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;token_type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Bearer&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;expires_in&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">3600</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="code-voucherissuance-interoperabilityapi-flow-accesstoken-header">
<div class="code-block-caption"><span class="caption-number">Listato 15.13 </span><span class="caption-text">Esempio non normativo del JOSE header di <code class="docutils literal notranslate"><span class="pre">access_token</span></code></span><a class="headerlink" href="#code-voucherissuance-interoperabilityapi-flow-accesstoken-header" title="Link to this code">¶</a></div>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;alg&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ES256&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;kid&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;b839f4c7-1e5d-4a8a-9fc6-72d3b7f091ec&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;typ&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;at+jwt&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="code-voucherissuance-interoperabilityapi-flow-accesstoken-payload">
<div class="code-block-caption"><span class="caption-number">Listato 15.14 </span><span class="caption-text">Esempio non normativo del payload di <code class="docutils literal notranslate"><span class="pre">access_token</span></code></span><a class="headerlink" href="#code-voucherissuance-interoperabilityapi-flow-accesstoken-payload" title="Link to this code">¶</a></div>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;iss&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://interop.pagopa.it&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;sub&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;5a3c7f28-91b9-4c4e-89a9-6e2f85d9262b&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;aud&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://interop.pagopa.it/api/v1&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;exp&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1733236680</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;nbf&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1733233158</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;iat&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1733233080</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;jti&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;f87e2d5b-9f65-4f0f-8ad4-92e58e6b13c7&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;client_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;5a3c7f28-91b9-4c4e-89a9-6e2f85d9262b&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</section>
</section>
<section id="endpoint-authorization-server-pdnd">
<h3><span class="section-number">15.2.2.3. </span>Endpoint Authorization Server PDND<a class="headerlink" href="#endpoint-authorization-server-pdnd" title="Link to this heading">¶</a></h3>
<p>L'Endpoint Authorization Server PDND emette Voucher agli Aderenti. Questi Voucher consentono ai Fruitori di accedere alle risorse degli e-Service e agli Erogatori di interagire con l'API di Interoperabilità.</p>
<section id="richiesta-voucher-pdnd">
<h4><span class="section-number">15.2.2.3.1. </span>Richiesta (Voucher PDND)<a class="headerlink" href="#richiesta-voucher-pdnd" title="Link to this heading">¶</a></h4>
<p>La richiesta all'Endpoint Authorization Server PDND aderisce al flusso Client Credentials Grant specificato in <span class="target" id="index-2"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc6749.html"><strong>RFC 6749</strong></a>. Il client si autentica presentando un'asserzione client basata su JWT come definito in <span class="target" id="index-3"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7521.html"><strong>RFC 7521</strong></a> e <span class="target" id="index-4"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7523.html"><strong>RFC 7523</strong></a>.</p>
<p>Seguendo le suddette specifiche, la richiesta DEVE essere una richiesta HTTP POST con un corpo codificato in formato <code class="docutils literal notranslate"><span class="pre">application/x-www-form-urlencoded</span></code>.</p>
<p>La <cite>Voucher Request</cite> DEVE includere i seguenti parametri nell'header HTTP (se non diversamente specificato):</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 20.0%" />
<col style="width: 60.0%" />
<col style="width: 20.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><strong>Parametro</strong></p></th>
<th class="head"><p><strong>Descrizione</strong></p></th>
<th class="head"><p><strong>Riferimento</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>DPoP</strong></p></td>
<td><p>JWT di <cite>DPoP proof</cite>, per rispettare il pattern di sicurezza <code class="docutils literal notranslate"><span class="pre">REST_JWS_2021_POP</span></code>. È obbligatorio solo se il Voucher richiesto è per e-Service (quindi non per API di Interoperabilità) e segue l'implementazione <code class="docutils literal notranslate"><span class="pre">POP_DPoP</span></code>.</p></td>
<td><p>[<span class="target" id="index-5"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc9449.html"><strong>RFC 9449</strong></a>], [<a class="reference external" href="https://www.agid.gov.it/sites/agid/files/2024-06/Linee_guida_infrastruttura_interoperabilita_pdnd.pdf">PDND</a>]</p></td>
</tr>
</tbody>
</table>
<p>La <cite>Voucher Request</cite> DEVE includere i seguenti parametri nel body:</p>
<table class="longtable docutils align-default">
<colgroup>
<col style="width: 20.0%" />
<col style="width: 60.0%" />
<col style="width: 20.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><strong>Parametro</strong></p></th>
<th class="head"><p><strong>Descrizione</strong></p></th>
<th class="head"><p><strong>Riferimento</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>client_id</strong></p></td>
<td><p>Identificativo univoco del Client dell'Aderente, assegnato dalla PDND.</p></td>
<td><p>[<span class="target" id="index-6"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc6749.html"><strong>RFC 6749</strong></a>], [<span class="target" id="index-7"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7521.html"><strong>RFC 7521</strong></a>], [<span class="target" id="index-8"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7523.html"><strong>RFC 7523</strong></a>], [<a class="reference external" href="https://www.agid.gov.it/sites/agid/files/2024-06/Linee_guida_infrastruttura_interoperabilita_pdnd.pdf">PDND</a>]</p></td>
</tr>
<tr class="row-odd"><td><p><strong>client_assertion</strong></p></td>
<td><p>Un JWT che rappresenta l'asserzione del client.</p></td>
<td><p>[<span class="target" id="index-9"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7521.html"><strong>RFC 7521</strong></a>], [<span class="target" id="index-10"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7523.html"><strong>RFC 7523</strong></a>], [<a class="reference external" href="https://www.agid.gov.it/sites/agid/files/2024-06/Linee_guida_infrastruttura_interoperabilita_pdnd.pdf">PDND</a>]</p></td>
</tr>
<tr class="row-even"><td><p><strong>client_assertion_type</strong></p></td>
<td><p>DEVE essere impostato su <code class="docutils literal notranslate"><span class="pre">urn:ietf:params:oauth:client-assertion-type:jwt-bearer</span></code>.</p></td>
<td><p>[<span class="target" id="index-11"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7521.html"><strong>RFC 7521</strong></a>], [<span class="target" id="index-12"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7523.html"><strong>RFC 7523</strong></a>]</p></td>
</tr>
<tr class="row-odd"><td><p><strong>grant_type</strong></p></td>
<td><p>DEVE essere impostato su <code class="docutils literal notranslate"><span class="pre">client_credentials</span></code>.</p></td>
<td><p>[<span class="target" id="index-13"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc6749.html"><strong>RFC 6749</strong></a>], [<span class="target" id="index-14"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7523.html"><strong>RFC 7523</strong></a>]</p></td>
</tr>
</tbody>
</table>
<p>Il JWT <code class="docutils literal notranslate"><span class="pre">client_assertion</span></code> DEVE includere i seguenti parametri nel JOSE header:</p>
<table class="longtable docutils align-default">
<colgroup>
<col style="width: 20.0%" />
<col style="width: 60.0%" />
<col style="width: 20.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><strong>Parametro</strong></p></th>
<th class="head"><p><strong>Descrizione</strong></p></th>
<th class="head"><p><strong>Riferimento</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>alg</strong></p></td>
<td><p>Identificativo di un algoritmo di firma digitale.</p></td>
<td><p>[<span class="target" id="index-15"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7515.html"><strong>RFC 7515</strong></a>]</p></td>
</tr>
<tr class="row-odd"><td><p><strong>kid</strong></p></td>
<td><p>Identificativo univoco del JWK utilizzato dall'Aderente per firmare <code class="docutils literal notranslate"><span class="pre">client_assertion</span></code>.</p></td>
<td><p>[<span class="target" id="index-16"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7515.html"><strong>RFC 7515</strong></a>]</p></td>
</tr>
<tr class="row-even"><td><p><strong>typ</strong></p></td>
<td><p>DEVE essere impostato su <code class="docutils literal notranslate"><span class="pre">JWT</span></code>.</p></td>
<td><p>[<span class="target" id="index-17"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7515.html"><strong>RFC 7515</strong></a>], [<span class="target" id="index-18"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7519.html"><strong>RFC 7519</strong></a>]</p></td>
</tr>
</tbody>
</table>
<p>Il JWT <code class="docutils literal notranslate"><span class="pre">client_assertion</span></code> DEVE includere i seguenti claim nel payload (se non diversamente specificato):</p>
<table class="longtable docutils align-default">
<colgroup>
<col style="width: 20.0%" />
<col style="width: 60.0%" />
<col style="width: 20.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><strong>Claim</strong></p></th>
<th class="head"><p><strong>Descrizione</strong></p></th>
<th class="head"><p><strong>Riferimento</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>iss</strong></p></td>
<td><p>DEVE essere impostato sullo stesso valore di <code class="docutils literal notranslate"><span class="pre">client_id</span></code>.</p></td>
<td><p>[<span class="target" id="index-19"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7523.html"><strong>RFC 7523</strong></a>]</p></td>
</tr>
<tr class="row-odd"><td><p><strong>sub</strong></p></td>
<td><p>DEVE essere impostato sullo stesso valore di <code class="docutils literal notranslate"><span class="pre">client_id</span></code>.</p></td>
<td><p>[<span class="target" id="index-20"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7523.html"><strong>RFC 7523</strong></a>]</p></td>
</tr>
<tr class="row-even"><td><p><strong>aud</strong></p></td>
<td><p>Identificativo dell'Endpoint Authorization Server PDND.</p></td>
<td><p>[<span class="target" id="index-21"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7523.html"><strong>RFC 7523</strong></a>]</p></td>
</tr>
<tr class="row-odd"><td><p><strong>exp</strong></p></td>
<td><p>Timestamp UNIX che rappresenta l'istante di scadenza del JWT.</p></td>
<td><p>[<span class="target" id="index-22"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7523.html"><strong>RFC 7523</strong></a>]</p></td>
</tr>
<tr class="row-even"><td><p><strong>nbf</strong></p></td>
<td><p>Timestamp UNIX che rappresenta il primo istante di validità del JWT (opzionale).</p></td>
<td><p>[<span class="target" id="index-23"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7519.html"><strong>RFC 7519</strong></a>]</p></td>
</tr>
<tr class="row-odd"><td><p><strong>iat</strong></p></td>
<td><p>Timestamp UNIX che rappresenta l'istante di emissione del JWT.</p></td>
<td><p>[<span class="target" id="index-24"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7523.html"><strong>RFC 7523</strong></a>]</p></td>
</tr>
<tr class="row-even"><td><p><strong>jti</strong></p></td>
<td><p>Identificativo univoco del JWT per prevenire attacchi di replay.</p></td>
<td><p>[<span class="target" id="index-25"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7523.html"><strong>RFC 7523</strong></a>]</p></td>
</tr>
<tr class="row-odd"><td><p><strong>purposeId</strong></p></td>
<td><p>Identificativo dello scopo registrato nella Piattaforma PDND, associato all'e-Service previsto. È obbligatorio solo se il Voucher richiesto è per e-Service (quindi non per API di Interoperabilità).</p></td>
<td><p>[<a class="reference external" href="https://www.agid.gov.it/sites/agid/files/2024-05/linee_guida_interoperabilit_tecnica_pa.pdf">MODI</a>], [<a class="reference external" href="https://www.agid.gov.it/sites/agid/files/2024-06/Linee_guida_infrastruttura_interoperabilita_pdnd.pdf">PDND</a>]</p></td>
</tr>
<tr class="row-even"><td><p><strong>digest</strong></p></td>
<td><p>Oggetto JSON contenente il digest del JWT <code class="docutils literal notranslate"><span class="pre">TrackingEvidence</span></code>. È obbligatorio solo se il Voucher richiesto è per e-Service (quindi non per API di Interoperabilità), e quando si rispetta <code class="docutils literal notranslate"><span class="pre">AUDIT_REST_02</span></code> o l'implementazione <code class="docutils literal notranslate"><span class="pre">POP_TPoP</span></code>. Se presente, DEVE contenere i seguenti claim:</p>
<ul class="simple">
<li><p><strong>alg</strong>: stringa JSON che rappresenta l'algoritmo di hashing;</p></li>
<li><p><strong>value</strong>: stringa JSON che rappresenta il valore del digest.</p></li>
</ul>
</td>
<td><p>[<a class="reference external" href="https://www.agid.gov.it/sites/agid/files/2024-05/linee_guida_interoperabilit_tecnica_pa.pdf">MODI</a>]</p></td>
</tr>
</tbody>
</table>
</section>
<section id="risposta-voucher-pdnd">
<h4><span class="section-number">15.2.2.3.2. </span>Risposta (Voucher PDND)<a class="headerlink" href="#risposta-voucher-pdnd" title="Link to this heading">¶</a></h4>
<p>La <cite>Voucher Response</cite> DEVE includere i seguenti parametri nel body:</p>
<table class="longtable docutils align-default">
<colgroup>
<col style="width: 20.0%" />
<col style="width: 60.0%" />
<col style="width: 20.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><strong>Parametro</strong></p></th>
<th class="head"><p><strong>Descrizione</strong></p></th>
<th class="head"><p><strong>Riferimento</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>access_token</strong></p></td>
<td><p>JWT che rappresenta l'Access Token emesso dall'Endpoint Authorization Server PDND.</p></td>
<td><p>[<span class="target" id="index-26"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc6749.html"><strong>RFC 6749</strong></a>], [<span class="target" id="index-27"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc9449.html"><strong>RFC 9449</strong></a>], [<a class="reference external" href="https://www.agid.gov.it/sites/agid/files/2024-06/Linee_guida_infrastruttura_interoperabilita_pdnd.pdf">PDND</a>]</p></td>
</tr>
<tr class="row-odd"><td><p><strong>token_type</strong></p></td>
<td><p>DEVE essere impostato su:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">DPoP</span></code> in caso di Voucher per e-Service seguendo l'implementazione <code class="docutils literal notranslate"><span class="pre">POP_DPoP</span></code>;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Bearer</span></code> in caso di Voucher per API di Interoperabilità, o Voucher per e-Service seguendo l'implementazione <code class="docutils literal notranslate"><span class="pre">POP_TPoP</span></code>.</p></li>
</ul>
</td>
<td><p>[<span class="target" id="index-28"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc6749.html"><strong>RFC 6749</strong></a>], [<span class="target" id="index-29"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc9449.html"><strong>RFC 9449</strong></a>]</p></td>
</tr>
<tr class="row-even"><td><p><strong>expires_in</strong></p></td>
<td><p>Numero che rappresenta la durata dell'Access Token in secondi come intero positivo.</p></td>
<td><p>[<span class="target" id="index-30"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc6749.html"><strong>RFC 6749</strong></a>], [<span class="target" id="index-31"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc9449.html"><strong>RFC 9449</strong></a>]</p></td>
</tr>
</tbody>
</table>
<p>Il JWT <code class="docutils literal notranslate"><span class="pre">access_token</span></code> DEVE includere i seguenti parametri nel JOSE header:</p>
<table class="longtable docutils align-default">
<colgroup>
<col style="width: 20.0%" />
<col style="width: 60.0%" />
<col style="width: 20.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><strong>Parametro</strong></p></th>
<th class="head"><p><strong>Descrizione</strong></p></th>
<th class="head"><p><strong>Riferimento</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>alg</strong></p></td>
<td><p>Identificativo di un algoritmo di firma digitale.</p></td>
<td><p>[<span class="target" id="index-32"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7515.html"><strong>RFC 7515</strong></a>]</p></td>
</tr>
<tr class="row-odd"><td><p><strong>kid</strong></p></td>
<td><p>Identificativo univoco del JWK utilizzato dall'Endpoint Authorization Server PDND per firmare <code class="docutils literal notranslate"><span class="pre">access_token</span></code>.</p></td>
<td><p>[<span class="target" id="index-33"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7515.html"><strong>RFC 7515</strong></a>]</p></td>
</tr>
<tr class="row-even"><td><p><strong>typ</strong></p></td>
<td><p>DEVE essere impostato su <code class="docutils literal notranslate"><span class="pre">at+jwt</span></code>.</p></td>
<td><p>[<span class="target" id="index-34"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc9068.html"><strong>RFC 9068</strong></a>]</p></td>
</tr>
</tbody>
</table>
<p>Il JWT <code class="docutils literal notranslate"><span class="pre">access_token</span></code> DEVE includere i seguenti claim nel payload (se non diversamente specificato):</p>
<table class="longtable docutils align-default">
<colgroup>
<col style="width: 20.0%" />
<col style="width: 60.0%" />
<col style="width: 20.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><strong>Claim</strong></p></th>
<th class="head"><p><strong>Descrizione</strong></p></th>
<th class="head"><p><strong>Riferimento</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>iss</strong></p></td>
<td><p>Identificativo dell'Authorization Server PDND.</p></td>
<td><p>[<span class="target" id="index-35"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7519.html"><strong>RFC 7519</strong></a>], [<span class="target" id="index-36"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc9068.html"><strong>RFC 9068</strong></a>]</p></td>
</tr>
<tr class="row-odd"><td><p><strong>sub</strong></p></td>
<td><p>Identificativo dell'Aderente, corrispondente al parametro <code class="docutils literal notranslate"><span class="pre">client_id</span></code> nel body della <cite>Voucher Request</cite>.</p></td>
<td><p>[<span class="target" id="index-37"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7519.html"><strong>RFC 7519</strong></a>], [<span class="target" id="index-38"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc9068.html"><strong>RFC 9068</strong></a>]</p></td>
</tr>
<tr class="row-even"><td><p><strong>aud</strong></p></td>
<td><p>Identificativo dell'e-Service.</p></td>
<td><p>[<span class="target" id="index-39"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7519.html"><strong>RFC 7519</strong></a>], [<span class="target" id="index-40"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc9068.html"><strong>RFC 9068</strong></a>]</p></td>
</tr>
<tr class="row-odd"><td><p><strong>exp</strong></p></td>
<td><p>Timestamp UNIX che rappresenta l'istante di scadenza del JWT.</p></td>
<td><p>[<span class="target" id="index-41"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7519.html"><strong>RFC 7519</strong></a>], [<span class="target" id="index-42"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc9068.html"><strong>RFC 9068</strong></a>]</p></td>
</tr>
<tr class="row-even"><td><p><strong>nbf</strong></p></td>
<td><p>Timestamp UNIX che rappresenta il primo istante di validità del JWT (opzionale).</p></td>
<td><p>[<span class="target" id="index-43"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7519.html"><strong>RFC 7519</strong></a>]</p></td>
</tr>
<tr class="row-odd"><td><p><strong>iat</strong></p></td>
<td><p>Timestamp UNIX che rappresenta l'istante di emissione del JWT.</p></td>
<td><p>[<span class="target" id="index-44"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7519.html"><strong>RFC 7519</strong></a>], [<span class="target" id="index-45"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc9068.html"><strong>RFC 9068</strong></a>]</p></td>
</tr>
<tr class="row-even"><td><p><strong>jti</strong></p></td>
<td><p>Identificativo univoco del JWT per prevenire attacchi di replay.</p></td>
<td><p>[<span class="target" id="index-46"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7519.html"><strong>RFC 7519</strong></a>], [<span class="target" id="index-47"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc9068.html"><strong>RFC 9068</strong></a>]</p></td>
</tr>
<tr class="row-odd"><td><p><strong>client_id</strong></p></td>
<td><p>DEVE corrispondere al <code class="docutils literal notranslate"><span class="pre">client_id</span></code> contenuto nella <cite>Voucher Request</cite>.</p></td>
<td><p>[<span class="target" id="index-48"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7519.html"><strong>RFC 7519</strong></a>], [<span class="target" id="index-49"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc8963.html"><strong>RFC 8963</strong></a>], [<span class="target" id="index-50"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc9068.html"><strong>RFC 9068</strong></a>], [<a class="reference external" href="https://www.agid.gov.it/sites/agid/files/2024-06/Linee_guida_infrastruttura_interoperabilita_pdnd.pdf">PDND</a>]</p></td>
</tr>
<tr class="row-even"><td><p><strong>purposeId</strong></p></td>
<td><p>DEVE corrispondere al valore del claim <code class="docutils literal notranslate"><span class="pre">purposeId</span></code> contenuto nella <cite>Voucher Request</cite>. È obbligatorio solo se il Voucher richiesto è per e-Service (cioè, non per API di Interoperabilità).</p></td>
<td><p>[<a class="reference external" href="https://www.agid.gov.it/sites/agid/files/2024-05/linee_guida_interoperabilit_tecnica_pa.pdf">MODI</a>], [<a class="reference external" href="https://www.agid.gov.it/sites/agid/files/2024-06/Linee_guida_infrastruttura_interoperabilita_pdnd.pdf">PDND</a>]</p></td>
</tr>
<tr class="row-odd"><td><p><strong>digest</strong></p></td>
<td><p>DEVE corrispondere al valore dell'oggetto <code class="docutils literal notranslate"><span class="pre">digest</span></code> contenuto nella <cite>Voucher Request</cite>. È obbligatorio solo quando si rispetta <code class="docutils literal notranslate"><span class="pre">AUDIT_REST_02</span></code> o l'implementazione <code class="docutils literal notranslate"><span class="pre">POP_TPoP</span></code>.</p></td>
<td><p>[<a class="reference external" href="https://www.agid.gov.it/sites/agid/files/2024-05/linee_guida_interoperabilit_tecnica_pa.pdf">MODI</a>]</p></td>
</tr>
<tr class="row-even"><td><p><strong>cnf</strong></p></td>
<td><p>DEVE contenere un claim <strong>jkt</strong> che è il JWK SHA-256 Thumbprint Confirmation Method. Il valore del claim <em>jkt</em> DEVE essere la codifica base64url (come definito in [<span class="target" id="index-51"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7515.html"><strong>RFC 7515</strong></a>]) del JWK SHA-256 Thumbprint della chiave pubblica DPoP (in formato JWK) a cui l'Access Token è associato. È obbligatorio solo quando si rispetta l'implementazione <code class="docutils literal notranslate"><span class="pre">POP_DPoP</span></code>.</p></td>
<td><p>[<span class="target" id="index-52"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc9449.html"><strong>RFC 9449</strong></a>. Sezione 6.1] e [<span class="target" id="index-53"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7638.html"><strong>RFC 7638</strong></a>].</p></td>
</tr>
</tbody>
</table>
<p>Se si verificano errori durante la validazione della <cite>Voucher Request</cite>, l'Endpoint Authorization Server PDND DEVE restituire una risposta di errore come definito in <span class="target" id="index-54"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc6749.html#section-5.2"><strong>RFC 6749#section-5.2</strong></a>. La risposta DEVE utilizzare <code class="docutils literal notranslate"><span class="pre">application/json</span></code> come <code class="docutils literal notranslate"><span class="pre">Content-Type</span></code> e DEVE includere i seguenti parametri:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">error</span></code>: Il codice di errore.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">error_description</span></code>: Testo in forma leggibile dall'uomo che fornisce ulteriori dettagli per chiarire la natura dell'errore incontrato.</p></li>
</ul>
</div></blockquote>
<div class="literal-block-wrapper docutils container" id="code-voucherissuance-endpoint-authorizationserver-error">
<div class="code-block-caption"><span class="caption-number">Listato 15.15 </span><span class="caption-text">Esempio non normativo di una <cite>Voucher Error Response</cite></span><a class="headerlink" href="#code-voucherissuance-endpoint-authorizationserver-error" title="Link to this code">¶</a></div>
<div class="highlight-http notranslate"><div class="highlight"><pre><span></span><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">400</span> <span class="ne">Bad Request</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">no-store</span>

<span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;invalid_request&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;error_description&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;The client_assertion_type parameter is missing.&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p>La seguente tabella elenca gli HTTP Status Code e i relativi codici di errore che DEVONO essere supportati per la risposta di errore:</p>
<table class="longtable docutils align-default">
<colgroup>
<col style="width: 20.0%" />
<col style="width: 20.0%" />
<col style="width: 60.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><strong>HTTP Status Code</strong></p></th>
<th class="head"><p><strong>Codice di Errore</strong></p></th>
<th class="head"><p><strong>Descrizione</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">400</span> <span class="pre">Bad</span> <span class="pre">Request</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">invalid_request</span></code></p></td>
<td><p>La richiesta non può essere soddisfatta perché mancano parametri richiesti, contiene parametri non validi o è in qualche modo malformata [<span class="target" id="index-55"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc6749.html#section-5.2"><strong>RFC 6749#section-5.2</strong></a>].</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">400</span> <span class="pre">Bad</span> <span class="pre">Request</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">invalid_grant</span></code></p></td>
<td><p>La richiesta non può essere soddisfatta perché il grant fornito (cioè, <code class="docutils literal notranslate"><span class="pre">client_assertion</span></code>) è scaduto, revocato, già utilizzato o in qualche modo malformato [<span class="target" id="index-56"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc6749.html#section-5.2"><strong>RFC 6749#section-5.2</strong></a>].</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">400</span> <span class="pre">Bad</span> <span class="pre">Request</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">unsupported_grant_type</span></code></p></td>
<td><p>La richiesta non può essere soddisfatta perché il tipo di grant fornito non è supportato dall'Authorization Server PDND [<span class="target" id="index-57"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc6749.html#section-5.2"><strong>RFC 6749#section-5.2</strong></a>].</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">400</span> <span class="pre">Bad</span> <span class="pre">Request</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">invalid_scope</span></code></p></td>
<td><p>La richiesta non può essere soddisfatta perché il <code class="docutils literal notranslate"><span class="pre">purposeId</span></code> fornito non è valido, è sconosciuto, malformato o non associato al Client [<span class="target" id="index-58"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc6749.html#section-5.2"><strong>RFC 6749#section-5.2</strong></a>].</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">400</span> <span class="pre">Bad</span> <span class="pre">Request</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">invalid_dpop_proof</span></code></p></td>
<td><p>La richiesta non può essere soddisfatta perché contiene una <em>DPoP proof</em> non valida [<span class="target" id="index-59"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc9449.html#section-5"><strong>RFC 9449#section-5</strong></a>].</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">401</span> <span class="pre">Unauthorized</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">invalid_client</span></code></p></td>
<td><p>La richiesta non può essere soddisfatta perché l'autenticazione del Client è fallita (quindi <code class="docutils literal notranslate"><span class="pre">client_assertion</span></code> è malformato, firmato in modo errato, mancante o non verificabile) [<span class="target" id="index-60"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc6749.html#section-5.2"><strong>RFC 6749#section-5.2</strong></a>].</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">500</span> <span class="pre">Internal</span> <span class="pre">Server</span> <span class="pre">Error</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">server_error</span></code></p></td>
<td><p>La richiesta non può essere soddisfatta perché l'Authorization Server PDND ha riscontrato un problema interno.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">503</span> <span class="pre">Service</span> <span class="pre">Unavailable</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">temporarily_unavailable</span></code></p></td>
<td><p>La richiesta non può essere soddisfatta perché l'Authorization Server PDND è temporaneamente non disponibile (ad esempio, a causa di manutenzione o sovraccarico).</p></td>
</tr>
</tbody>
</table>
</section>
</section>
</section>
<section id="reperimento-delle-chiavi">
<h2><span class="section-number">15.2.3. </span>Reperimento delle Chiavi<a class="headerlink" href="#reperimento-delle-chiavi" title="Link to this heading">¶</a></h2>
<section id="chiavi-dell-authorization-server-pdnd">
<h3><span class="section-number">15.2.3.1. </span>Chiavi dell'Authorization Server PDND<a class="headerlink" href="#chiavi-dell-authorization-server-pdnd" title="Link to this heading">¶</a></h3>
<figure class="align-default" id="id3">
<span id="fig-keyretrieval-pdnd-flow"></span><p class="plantuml">
<object data="_images/plantuml-ec6b6cf349359821286257f5c2155bbec0fa977f.svg" type="image/svg+xml" style="width:80%">
<a href="_images/plantuml-ec6b6cf349359821286257f5c2155bbec0fa977f.png"><img src="_images/plantuml-ec6b6cf349359821286257f5c2155bbec0fa977f.png" alt="La figura illustra il reperimento delle chiavi dell'Authorization Server PDND - Flusso dettagliato." style="width: 80.0%"/></a>

</object></p>
<figcaption>
<p><span class="caption-number">Fig. 15.4 </span><span class="caption-text"><a class="reference external" href="https://www.plantuml.com/plantuml/svg/RSx1IWCn58NXVPxYK7U1-01Tb1Qw40ILp6BMQNl4q4nIRsvc79_UgOWAkZsN_-DkgmRHDYJSSuQdIkGO4XoUzWzxer4J_p-PqBJaDXmenXpA6wozxjRYPlVUX0QuB7Gynal8YfMrjnDJSkTSfcpj2g6YDymdBF6t86MC9yfLkIkPyvxJN-Xnr_G5dhKqEH8TPQHyaRxxCNtdDlqQdg-DLV5SvFDrd3bNOthdDhvR_vgsIzc6z040">Reperimento delle chiavi dell'Authorization Server PDND - Flusso dettagliato.</a></span><a class="headerlink" href="#id3" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<p><strong>Passo 1 (Richiesta delle chiavi)</strong>: L'Erogatore richiede le chiavi utilizzate dalla PDND per firmare i Voucher.</p>
<div class="literal-block-wrapper docutils container" id="code-keyretrieval-pdnd-flow-request">
<div class="code-block-caption"><span class="caption-number">Listato 15.16 </span><span class="caption-text">Esempio non normativo della <cite>Keys Request</cite></span><a class="headerlink" href="#code-keyretrieval-pdnd-flow-request" title="Link to this code">¶</a></div>
<div class="highlight-http notranslate"><div class="highlight"><pre><span></span><span class="nf">GET</span> <span class="nn">/.well-known/jwks.json</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">interop.pagopa.it</span>
</pre></div>
</div>
</div>
<p><strong>Passo 2 (Risposta)</strong>: L'Endpoint .well-known restituisce l'elenco delle chiavi utilizzate dalla PDND per firmare i Voucher, come un <code class="docutils literal notranslate"><span class="pre">JWK</span> <span class="pre">Set</span></code> [<span class="target" id="index-61"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7517.html"><strong>RFC 7517</strong></a>].</p>
<div class="literal-block-wrapper docutils container" id="code-keyretrieval-pdnd-flow-response">
<div class="code-block-caption"><span class="caption-number">Listato 15.17 </span><span class="caption-text">Esempio non normativo della <cite>Keys Response</cite></span><a class="headerlink" href="#code-keyretrieval-pdnd-flow-response" title="Link to this code">¶</a></div>
<div class="highlight-http notranslate"><div class="highlight"><pre><span></span><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>

<span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;keys&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;kty&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;RSA&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;n&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;qU2Bp7xgkXBQI2w2PZ5LZGo34TIjoir-ul0x4jZ_d9hN6q...&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;e&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;AQAB&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;alg&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ES256&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;kid&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;b839f4c7-1e5d-4a8a-9fc6-72d3b7f091ec&quot;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;kty&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;RSA&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;n&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;05VukHBwiE1W_kgUS0zkOyHCrRivgw5cfSTmcvD_phieEY...&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;e&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;AQAB&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;alg&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ES256&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;kid&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;9432c16b-7aae-49df-b9c4-ea61b556652b&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</section>
<section id="endpoint-well-known-dell-authorization-server-pdnd">
<h3><span class="section-number">15.2.3.2. </span>Endpoint .well-known dell'Authorization Server PDND<a class="headerlink" href="#endpoint-well-known-dell-authorization-server-pdnd" title="Link to this heading">¶</a></h3>
<p>L'Endpoint .well-known fa parte dell'Infrastruttura PDND ed è utilizzato per reperire le chiavi pubbliche utilizzate dall'Authorization Server PDND per firmare i Voucher.</p>
<section id="richiesta-chiavi-dell-authorization-server-pdnd">
<h4><span class="section-number">15.2.3.2.1. </span>Richiesta (Chiavi dell'Authorization Server PDND)<a class="headerlink" href="#richiesta-chiavi-dell-authorization-server-pdnd" title="Link to this heading">¶</a></h4>
<p>La <cite>Keys Request</cite> è una richiesta HTTP <code class="docutils literal notranslate"><span class="pre">GET</span></code> inviata all'Endpoint .well-known. Questo endpoint consente agli Aderenti di reperire le chiavi pubbliche necessarie per verificare le firme digitali sui Voucher emessi dall'Authorization Server PDND.</p>
</section>
<section id="risposta-chiavi-dell-authorization-server-pdnd">
<h4><span class="section-number">15.2.3.2.2. </span>Risposta (Chiavi dell'Authorization Server PDND)<a class="headerlink" href="#risposta-chiavi-dell-authorization-server-pdnd" title="Link to this heading">¶</a></h4>
<p>L'Endpoint .well-known risponde con un HTTP Status Code <code class="docutils literal notranslate"><span class="pre">200</span> <span class="pre">OK</span></code> e un <code class="docutils literal notranslate"><span class="pre">JWK</span> <span class="pre">Set</span></code> [<span class="target" id="index-62"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7517.html"><strong>RFC 7517</strong></a>] contenente le chiavi pubbliche impiegate dall'Authorization Server PDND per firmare i Voucher.</p>
<p>Se si verificano errori durante il reperimento delle chiavi, l'Endpoint .well-known DEVE restituire una risposta di errore. La risposta DEVE utilizzare <code class="docutils literal notranslate"><span class="pre">application/json</span></code> come <code class="docutils literal notranslate"><span class="pre">Content-Type</span></code> e DEVE includere i seguenti parametri:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">error</span></code>: Il codice di errore.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">error_description</span></code>: Testo in forma leggibile dall'uomo che fornisce ulteriori dettagli per chiarire la natura dell'errore incontrato.</p></li>
</ul>
</div></blockquote>
<div class="literal-block-wrapper docutils container" id="code-keyretrieval-endpoint-wellknown-error">
<div class="code-block-caption"><span class="caption-number">Listato 15.18 </span><span class="caption-text">Esempio non normativo di una <cite>Keys Error Response</cite></span><a class="headerlink" href="#code-keyretrieval-endpoint-wellknown-error" title="Link to this code">¶</a></div>
<div class="highlight-http notranslate"><div class="highlight"><pre><span></span><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">500</span> <span class="ne">Internal Server Error</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>

<span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;server_error&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;error_description&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;The server encountered an unexpected error.&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p>La seguente tabella elenca gli HTTP Status Code e i relativi codici di errore che DEVONO essere supportati per la risposta di errore:</p>
<table class="longtable docutils align-default">
<colgroup>
<col style="width: 20.0%" />
<col style="width: 20.0%" />
<col style="width: 60.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><strong>HTTP Status Code</strong></p></th>
<th class="head"><p><strong>Codice di Errore</strong></p></th>
<th class="head"><p><strong>Descrizione</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">500</span> <span class="pre">Internal</span> <span class="pre">Server</span> <span class="pre">Error</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">server_error</span></code></p></td>
<td><p>La richiesta non può essere soddisfatta perché l'Endpoint .well-known ha riscontrato un problema interno.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">503</span> <span class="pre">Service</span> <span class="pre">Unavailable</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">temporarily_unavailable</span></code></p></td>
<td><p>La richiesta non può essere soddisfatta perché l'Endpoint .well-known è temporaneamente non disponibile (ad esempio, a causa di manutenzione o sovraccarico).</p></td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="chiavi-degli-aderenti">
<h3><span class="section-number">15.2.3.3. </span>Chiavi degli Aderenti<a class="headerlink" href="#chiavi-degli-aderenti" title="Link to this heading">¶</a></h3>
<section id="prerequisiti-per-il-reperimento-delle-chiavi-degli-aderenti">
<h4><span class="section-number">15.2.3.3.1. </span>Prerequisiti per il Reperimento delle Chiavi degli Aderenti<a class="headerlink" href="#prerequisiti-per-il-reperimento-delle-chiavi-degli-aderenti" title="Link to this heading">¶</a></h4>
<p>L'<strong>Aderente</strong> che richiede la chiave DEVE rispettare i seguenti prerequisiti:</p>
<blockquote>
<div><ul class="simple">
<li><p>Ha completato con successo l'adesione all'Infrastruttura PDND (come da R1).</p></li>
<li><p>Ha creato un nuovo <cite>Client api interop</cite> per interagire con l'API di Interoperabilità PDND. Al momento della creazione, gli è stato assegnato un <code class="docutils literal notranslate"><span class="pre">client_id</span></code> dalla Piattaforma PDND.</p></li>
<li><p>Ha registrato una coppia di chiavi associata al <cite>Client api interop</cite>.</p></li>
<li><p>Ha ottenuto un Voucher valido per interrogare l'API di Interoperabilità PDND, relativo allo specifico <cite>Client api interop</cite>.</p></li>
</ul>
</div></blockquote>
</section>
<section id="flusso-di-reperimento-delle-chiavi-degli-aderenti">
<h4><span class="section-number">15.2.3.3.2. </span>Flusso di Reperimento delle Chiavi degli Aderenti<a class="headerlink" href="#flusso-di-reperimento-delle-chiavi-degli-aderenti" title="Link to this heading">¶</a></h4>
<figure class="align-default" id="id4">
<span id="fig-keyretrieval-participant-flow"></span><p class="plantuml">
<object data="_images/plantuml-cd8f37818971a62efdf6c4cfe370d76fde507aa5.svg" type="image/svg+xml" style="width:80%">
<a href="_images/plantuml-cd8f37818971a62efdf6c4cfe370d76fde507aa5.png"><img src="_images/plantuml-cd8f37818971a62efdf6c4cfe370d76fde507aa5.png" alt="La figura illustra il reperimento delle chiavi degli Aderenti - Flusso dettagliato." style="width: 80.0%"/></a>

</object></p>
<figcaption>
<p><span class="caption-number">Fig. 15.5 </span><span class="caption-text"><a class="reference external" href="https://www.plantuml.com/plantuml/svg/fSp1IiGm4CRnUvxY8nw4mBx07fOjRS4YQDcpbxITrM7J92OJjJwz5SGAWXUlC__lTynYavJPuPOMd4WIqujrsA5Vxpnoj5wo4XP7VoVA5Wc-p0CbfORm1cFwvgun1bVLUqcaWBZrqCPqNYY5ICaEx5WML7rdZ8RDw1Jv2QloJMtJJ_4cU5eQUlsDtbT5db0x9YzVMDrkMjtk3jt-HC-5ik0S4dx8rncn38v7N6Xvy6D8YN8CVcB_20d8aKO-hs-jBpnfhQ2wtQ5kz_ynZkIdChiF">Reperimento delle chiavi degli Aderenti - Flusso dettagliato.</a></span><a class="headerlink" href="#id4" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<p><strong>Passo 1 (Richiesta della chiave)</strong>: L'Aderente richiede la chiave utilizzata da un altro Aderente, corrispondente a uno specifico <code class="docutils literal notranslate"><span class="pre">kid</span></code>, alle API di Interoperabilità PDND.</p>
<div class="literal-block-wrapper docutils container" id="code-keyretrieval-participant-flow-request">
<div class="code-block-caption"><span class="caption-number">Listato 15.19 </span><span class="caption-text">Esempio non normativo della <cite>Key Request</cite></span><a class="headerlink" href="#code-keyretrieval-participant-flow-request" title="Link to this code">¶</a></div>
<div class="highlight-http notranslate"><div class="highlight"><pre><span></span><span class="nf">GET</span> <span class="nn">/keys/c7e3d6a4-5b99-4298-9b84-d8f3a61279f1</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">interop.pagopa.it</span>
<span class="na">Authorization</span><span class="o">:</span> <span class="l">Bearer eyJhbGciOiJFUzI1NiIsImtpZCI6ImI4MzlmNGM3LTFlNWQtNGE4YS05ZmM2LTcyZDNiN2YwOTFlYyIsInR5cCI6ImF0K2p3dCJ9.eyJpc3MiOiJpbnRlcm9wLnBhZ29wYS5pdCIsInN1YiI6IjVhM2M3ZjI4LTkxYjktNGM0ZS04OWE5LTZlMmY4NWQ5MjYyYiIsImF1ZCI6Imh0dHBzOi8vaW50ZXJvcC5wYWdvcGEuaXQvYXBpL3YxIiwiZXhwIjoxNzMzMjM2NjgwLCJuYmYiOjE3MzMyMzMxNTgsImlhdCI6MTczMzIzMzA4MCwianRpIjoiZjg3ZTJkNWItOWY2NS00ZjBmLThhZDQtOTJlNThlNmIxM2M3IiwiY2xpZW50X2lkIjoiNWEzYzdmMjgtOTFiOS00YzRlLTg5YTktNmUyZjg1ZDkyNjJiIn0.SKDDap16Ubi6gYwpKVdBcuhmhF_XnGiHeoxkF8F4IAualYORu_TxnDZqeP_RCcBAxSRkJTFbMihPCLA7DoRQOw</span>
</pre></div>
</div>
</div>
<p><strong>Passo 2 (Risposta)</strong>: L'Endpoint API di Interoperabilità restituisce la chiave richiesta, come un <code class="docutils literal notranslate"><span class="pre">JWK</span></code> [<span class="target" id="index-63"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7517.html"><strong>RFC 7517</strong></a>].</p>
<div class="literal-block-wrapper docutils container" id="code-keyretrieval-participant-flow-response">
<div class="code-block-caption"><span class="caption-number">Listato 15.20 </span><span class="caption-text">Esempio non normativo della <cite>Key Response</cite></span><a class="headerlink" href="#code-keyretrieval-participant-flow-response" title="Link to this code">¶</a></div>
<div class="highlight-http notranslate"><div class="highlight"><pre><span></span><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>

<span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;kty&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;EC&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;key_ops&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s2">&quot;sign&quot;</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="nt">&quot;kid&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;b839f4c7-1e5d-4a8a-9fc6-72d3b7f091ec&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;crv&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;P-256&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;x&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;huyXIQNv902oLspX4_zonC94G6yEln6lsdm-1wM732o&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;y&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;I9PDEawWHqaFDGx1ZkNk-2PV6WdpcaH3AfObBSLihgw&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>L'API di Interoperabilità include un endpoint di notifica degli eventi che avvisa gli Aderenti iscritti sui cambiamenti all'interno dell'Infrastruttura PDND. Tra queste notifiche, l'endpoint <code class="docutils literal notranslate"><span class="pre">/events/keys</span></code> fornisce aggiornamenti sulle modifiche al materiale crittografico, come aggiunte o eliminazioni di chiavi. Sfruttando questo meccanismo, gli Aderenti possono implementare una strategia di polling periodico per recuperare tutte le chiavi modificate e aggiornare la loro cache locale. Ciò elimina la necessità di richiedere ogni chiave individualmente durante il flusso.</p>
</div>
</section>
</section>
<section id="endpoint-api-di-interoperabilita-pdnd">
<h3><span class="section-number">15.2.3.4. </span>Endpoint API di Interoperabilità PDND<a class="headerlink" href="#endpoint-api-di-interoperabilita-pdnd" title="Link to this heading">¶</a></h3>
<p>L'Endpoint API di Interoperabilità fa parte dell'Infrastruttura PDND ed è utilizzato per recuperare le chiavi pubbliche di altri Aderenti all'Infrastruttura PDND.</p>
<section id="richiesta-chiave-da-api-di-interoperabilita-pdnd">
<h4><span class="section-number">15.2.3.4.1. </span>Richiesta (Chiave da API di Interoperabilità PDND)<a class="headerlink" href="#richiesta-chiave-da-api-di-interoperabilita-pdnd" title="Link to this heading">¶</a></h4>
<p>La <cite>Key Request</cite> è una richiesta HTTP <code class="docutils literal notranslate"><span class="pre">GET</span></code> inviata all'API <code class="docutils literal notranslate"><span class="pre">/keys/&lt;kid&gt;</span></code>. Questa richiesta viene utilizzata per recuperare una chiave specifica identificata dal suo <code class="docutils literal notranslate"><span class="pre">kid</span></code> univoco.</p>
<p>La <cite>Key Request</cite> DEVE includere i seguenti parametri di header HTTP:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 20.0%" />
<col style="width: 60.0%" />
<col style="width: 20.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><strong>Parametro</strong></p></th>
<th class="head"><p><strong>Descrizione</strong></p></th>
<th class="head"><p><strong>Riferimento</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>Authorization</strong></p></td>
<td><p>Voucher rilasciato dall'Authorization Server PDND.</p></td>
<td><p>[<span class="target" id="index-64"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc9449.html"><strong>RFC 9449</strong></a>]</p></td>
</tr>
</tbody>
</table>
</section>
<section id="risposta-chiave-da-api-di-interoperabilita-pdnd">
<h4><span class="section-number">15.2.3.4.2. </span>Risposta (Chiave da API di Interoperabilità PDND)<a class="headerlink" href="#risposta-chiave-da-api-di-interoperabilita-pdnd" title="Link to this heading">¶</a></h4>
<p>Nel caso in cui esista una chiave pubblica con il <code class="docutils literal notranslate"><span class="pre">kid</span></code> fornito, l'Endpoint dell'API di Interoperabilità risponde con un codice di stato <code class="docutils literal notranslate"><span class="pre">200</span> <span class="pre">OK</span></code> e un <code class="docutils literal notranslate"><span class="pre">JWK</span></code> [<span class="target" id="index-65"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7517.html"><strong>RFC 7517</strong></a>] che rappresenta quella chiave.</p>
<p>Se si verificano errori durante il reperimento della chiave, l'Endpoint API di Interoperabilità DEVE restituire un errore, la cui struttura dipende dalla natura dell'errore.</p>
<p>In caso di problemi di autenticazione (cioè, Voucher non valido o scaduto), la risposta DEVE aderire al formato di errore definito in <span class="target" id="index-66"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc6750.html#section-3"><strong>RFC 6750#section-3</strong></a>, con specifico riferimento all'uso del parametro di header <code class="docutils literal notranslate"><span class="pre">WWW-Authenticate</span></code>.</p>
<div class="literal-block-wrapper docutils container" id="code-keyretrieval-endpoint-interoperabilityapi-error-401">
<div class="code-block-caption"><span class="caption-number">Listato 15.21 </span><span class="caption-text">Esempio non normativo di una <cite>Key Error Response</cite> in caso di errori 401</span><a class="headerlink" href="#code-keyretrieval-endpoint-interoperabilityapi-error-401" title="Link to this code">¶</a></div>
<div class="highlight-http notranslate"><div class="highlight"><pre><span></span><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">401</span> <span class="ne">Unauthorized</span>
<span class="na">WWW-Authenticate</span><span class="o">:</span> <span class="l">Bearer error=&quot;invalid_token&quot;, error_description=&quot;The access token expired&quot;</span>
</pre></div>
</div>
</div>
<p>Per tutti gli altri errori, la risposta DEVE aderire al formato di errore definito in <span class="target" id="index-67"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc6749.html#section-5.2"><strong>RFC 6749#section-5.2</strong></a>. La risposta DEVE utilizzare <code class="docutils literal notranslate"><span class="pre">application/json</span></code> come tipo di contenuto e DEVE includere i seguenti parametri:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">error</span></code>: Il codice di errore.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">error_description</span></code>: Testo in forma leggibile dall'uomo che fornisce ulteriori dettagli per chiarire la natura dell'errore incontrato.</p></li>
</ul>
</div></blockquote>
<div class="literal-block-wrapper docutils container" id="code-keyretrieval-endpoint-interoperabilityapi-error-others">
<div class="code-block-caption"><span class="caption-number">Listato 15.22 </span><span class="caption-text">Esempio non normativo di una <cite>Key Error Response</cite> in caso di altri errori</span><a class="headerlink" href="#code-keyretrieval-endpoint-interoperabilityapi-error-others" title="Link to this code">¶</a></div>
<div class="highlight-http notranslate"><div class="highlight"><pre><span></span><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">400</span> <span class="ne">Bad Request</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>

<span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;invalid_request&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;error_description&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;The kid parameter is missing.&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p>La seguente tabella elenca gli HTTP Status Code e i relativi codici di errore che DEVONO essere supportati per la risposta di errore:</p>
<table class="longtable docutils align-default">
<colgroup>
<col style="width: 20.0%" />
<col style="width: 20.0%" />
<col style="width: 60.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><strong>HTTP Status Code</strong></p></th>
<th class="head"><p><strong>Codice di Errore</strong></p></th>
<th class="head"><p><strong>Descrizione</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">400</span> <span class="pre">Bad</span> <span class="pre">Request</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">invalid_request</span></code></p></td>
<td><p>La richiesta non può essere soddisfatta perché mancano parametri richiesti, contiene parametri non validi o è in qualche modo malformata [<span class="target" id="index-68"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc6750.html#section-3.1"><strong>RFC 6750#section-3.1</strong></a>].</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">401</span> <span class="pre">Unauthorized</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">invalid_token</span></code></p></td>
<td><p>La richiesta non può essere soddisfatta perché il Voucher è scaduto, revocato, malformato o in qualche modo non valido [<span class="target" id="index-69"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc6750.html#section-3.1"><strong>RFC 6750#section-3.1</strong></a>].</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">404</span> <span class="pre">Not</span> <span class="pre">Found</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">not_found</span></code></p></td>
<td><p>La richiesta non può essere soddisfatta perché non è stata trovata alcuna chiave pubblica corrispondente al <code class="docutils literal notranslate"><span class="pre">kid</span></code> fornito.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">500</span> <span class="pre">Internal</span> <span class="pre">Server</span> <span class="pre">Error</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">server_error</span></code></p></td>
<td><p>La richiesta non può essere soddisfatta perché l'Endpoint API di Interoperabilità ha riscontrato un problema interno.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">503</span> <span class="pre">Service</span> <span class="pre">Unavailable</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">temporarily_unavailable</span></code></p></td>
<td><p>La richiesta non può essere soddisfatta perché l'Endpoint API di Interoperabilità è temporaneamente non disponibile (ad esempio, a causa di manutenzione o sovraccarico).</p></td>
</tr>
</tbody>
</table>
</section>
</section>
</section>
<section id="utilizzo-dell-e-service">
<h2><span class="section-number">15.2.4. </span>Utilizzo dell'e-Service<a class="headerlink" href="#utilizzo-dell-e-service" title="Link to this heading">¶</a></h2>
<section id="prerequisiti-per-l-utilizzo-dell-e-service">
<h3><span class="section-number">15.2.4.1. </span>Prerequisiti per l'Utilizzo dell'e-Service<a class="headerlink" href="#prerequisiti-per-l-utilizzo-dell-e-service" title="Link to this heading">¶</a></h3>
<p>Il <strong>Fruitore</strong> DEVE rispettare i seguenti prerequisiti:</p>
<blockquote>
<div><ul class="simple">
<li><p>Ha ottenuto un Voucher valido per interagire con l'e-Service desiderato, relativo a uno specifico <cite>Client e-service</cite>.</p></li>
</ul>
</div></blockquote>
<p>L'<strong>Erogatore</strong> DEVE rispettare i seguenti prerequisiti:</p>
<blockquote>
<div><ul class="simple">
<li><p>Ha creato un nuovo portachiavi associato allo specifico e-Service.</p></li>
<li><p>Ha registrato una coppia di chiavi associata al portachiavi.</p></li>
</ul>
</div></blockquote>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Il portachiavi dell'Erogatore è la controparte del Client relativo al Fruitore. Memorizza materiale crittografico, consentendo ai Fruitori di verificare l'integrità delle risposte dagli Erogatori.</p>
</div>
</section>
<section id="flusso-di-utilizzo-dell-e-service">
<h3><span class="section-number">15.2.4.2. </span>Flusso di Utilizzo dell'e-Service<a class="headerlink" href="#flusso-di-utilizzo-dell-e-service" title="Link to this heading">¶</a></h3>
<figure class="align-default" id="id5">
<span id="fig-usage-flow"></span><p class="plantuml">
<object data="_images/plantuml-2b3dffd601356e0f71db2689540a61806a80b336.svg" type="image/svg+xml" style="width:80%">
<a href="_images/plantuml-2b3dffd601356e0f71db2689540a61806a80b336.png"><img src="_images/plantuml-2b3dffd601356e0f71db2689540a61806a80b336.png" alt="La figura illustra l'Utilizzo dell'e-Service - Flusso dettagliato." style="width: 80.0%"/></a>

</object></p>
<figcaption>
<p><span class="caption-number">Fig. 15.6 </span><span class="caption-text"><a class="reference external" href="https://www.plantuml.com/plantuml/svg/ZP31RjGm48RlVegHUm5BAo6EFQ2kaYuK8RfAjd1SkSwGM9jumdYyPVlqE4sxiAfQzHB5zlpVVFelebYMDFI0Ynfvxnt2JRGjAl7IuxDRPPDGICCjibAtz0UCAIZ4D20R0sTNU-A30XWpr3i_sY2WZRbU9kcWw3q6CKQ3ZL2i58O6CkA9iow_bnDZUPyONs9C7s9_RyLJWCaD-P6uh9yHcVQ-cSs-KC13YNSlWIkCbDZXARFwZrci5f-ArVcQCGCGllxSm9tFoUZRO2KnmZkjwwU3rk-F4IWOhI2KQrh3o4I_vgUgFeVIYitBVoUCClD-K7BTL2y7oY7ADja3phxvjfFFZ1WKGD6Xsu7M4rBhIV9X-cqXwnp6k1NQOJW9qoXm7Vh3BABrygQyscohotgp_V0nJmAyXl-tOCFMxNneBwVwWyE7w75D_dcRvx7C4ycgNiojFhQ63JHMhBh88sde_m80">Utilizzo dell'e-Service - Flusso dettagliato.</a></span><a class="headerlink" href="#id5" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<p><strong>Passo 1 (Preparazione della firma):</strong> Il Fruitore prepara un JWT (<code class="docutils literal notranslate"><span class="pre">Signature</span></code>) contenente le intestazioni firmate del messaggio, per garantire l'integrità.</p>
<div class="literal-block-wrapper docutils container" id="code-usage-flow-signature-header">
<div class="code-block-caption"><span class="caption-number">Listato 15.23 </span><span class="caption-text">Esempio non normativo dell'header di <code class="docutils literal notranslate"><span class="pre">Signature</span></code></span><a class="headerlink" href="#code-usage-flow-signature-header" title="Link to this code">¶</a></div>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;alg&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ES256&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;kid&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;d4c3b2a1-9876-5432-10fe-dcba98765432&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;typ&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;JWT&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="code-usage-flow-signature-payload">
<div class="code-block-caption"><span class="caption-number">Listato 15.24 </span><span class="caption-text">Esempio non normativo del payload di <code class="docutils literal notranslate"><span class="pre">Signature</span></code></span><a class="headerlink" href="#code-usage-flow-signature-payload" title="Link to this code">¶</a></div>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;iss&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;9a8b7c6d-e5f4-g3h2-i1j0-klmnopqrstuv&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;sub&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;9a8b7c6d-e5f4-g3h2-i1j0-klmnopqrstuv&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;aud&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://erogatore.example/ente-example/v1&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;iat&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1733397840</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;nbf&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1733401628</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;exp&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1733401440</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;jti&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;d3f7b2c9-274a-42b7-8f8d-2e9d8b1734b0&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;signed_headers&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span><span class="nt">&quot;digest&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;SHA-256=72e18bdddf13c911b4dd562ee21979a5c9f235c3a01bd1426e857d8c1a282f41&quot;</span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="nt">&quot;content-type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;application/json&quot;</span><span class="p">}</span>
<span class="w">    </span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Il passo 1 è richiesto per rispettare il pattern di sicurezza <code class="docutils literal notranslate"><span class="pre">INTEGRITY_REST_02</span></code>.</p>
</div>
<p><strong>Passo 2 (`DPoP proof`)</strong>: Il Fruitore DEVE creare un nuovo JWT di <cite>DPoP proof</cite> seguendo le istruzioni fornite nella Sezione 4 di [<span class="target" id="index-70"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc9449.html"><strong>RFC 9449</strong></a>] per la presentazione del token all'Endpoint e-Service.</p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Il passo 2 è richiesto solo quando si rispetta l'implementazione <code class="docutils literal notranslate"><span class="pre">POP_DPoP</span></code>.</p>
</div>
<p><strong>Passo 3 (Richiesta e-Service):</strong> Il Fruitore invia una <cite>e-Service Request</cite> all'Erogatore, includendo il Voucher.</p>
<div class="literal-block-wrapper docutils container" id="code-usage-flow-request">
<div class="code-block-caption"><span class="caption-number">Listato 15.25 </span><span class="caption-text">Esempio non normativo della <cite>e-Service Request</cite></span><a class="headerlink" href="#code-usage-flow-request" title="Link to this code">¶</a></div>
<div class="highlight-http notranslate"><div class="highlight"><pre><span></span><span class="nf">POST</span> <span class="nn">/ente-example/v1/hello/echo/</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">erogatore.example</span>
<span class="na">Authorization</span><span class="o">:</span> <span class="l">DPoP eyJhbGciOiJFUzI1NiIsImtpZCI6ImI4MzlmNGM3LTFlNWQtNGE4YS05ZmM2LTcyZDNiN2YwOTFlYyIsInR5cCI6ImF0K2p3dCJ9.eyJpc3MiOiJpbnRlcm9wLnBhZ29wYS5pdCIsInN1YiI6IjgyOTE0YjNmLTYwYjItNDUyOS1iNGQ2LTNkNGU2N2YwYTkzMyIsImF1ZCI6Imh0dHBzOi8vZXJvZ2F0b3JlLmV4YW1wbGUvZW50ZS1leGFtcGxlL3YxIiwiZXhwIjoxNzMzMDQyMTUwLCJuYmYiOjE3MzMwNDE5NDUsImlhdCI6MTczMzA0MTkyMCwianRpIjoiYzRmNWQ3ZTItYjdjOC00MGY2LTliNmEtZGM5YTRmNWFlYjU3IiwiY2xpZW50X2lkIjoiODI5MTRiM2YtNjBiMi00NTI5LWI0ZDYtM2Q0ZTY3ZjBhOTMzIiwicHVycG9zZUlkIjoiZDJiOWE2NTMtYzQ5Ny00NWM2LWI4ZjEtNWJkZjEyNGM5ZDNhIiwiZGlnZXN0Ijp7ImFsZyI6IlNIQTI1NiIsInZhbHVlIjoiOTkwOGQ5NGI4ZmViMjY4YzAzNzEwNmQ3Yzg5ZTcwNjBjMmNjMWY2YjJiNGViY2I4MDViZmVlNTNhNTM5MzA3YiJ9LCJjbmYiOnsiamt0IjoiMFpjT0NPUlpOWXktRFdwcXEzMGpaeUpHSFROMGQySGdsQlYzdWlndUE0SSJ9fQ.sGhaHEOfMTB7r4_8ZILM_a9eTBGawWn3kL-dxYoZggFIzyrXDOZcQWt0zr00lMk2iYAMWxS32e4cUedmAsBXGw</span>
<span class="na">DPoP</span><span class="o">:</span> <span class="l">eyJ0eXAiOiJkcG9wK2p3dCIsImFsZyI6IkVTMjU2IiwiandrIjp7Imt0eSI6IkVDIiwia2V5X29wcyI6WyJzaWduIl0sImtpZCI6IjM5ZmE5NjBiLTc3M2YtNDllZi04YTBlLWU3NzNlOWI5N2FlOCIsImNydiI6IlAtMjU2IiwieCI6Imh1eVhJUU52OTAyb0xzcFg0X3pvbkM5NEc2eUVsbjZsc2RtLTF3TTczMm8iLCJ5IjoiSTlQREVhd1dIcWFGREd4MVprTmstMlBWNldkcGNhSDNBZk9iQlNMaWhndyJ9fQ.eyJqdGkiOiIyYzc2ZmNhMy1jYjRlLTQzMTItOGI2ZS05NzQ5NDYyZjQyMGQiLCJodG0iOiJQT1NUIiwiYXRoIjoiM2UwOGRlMWQwYTNkZjIzNWZjZmNjZjYyNjdmYTUwYTU5YmEyYTk1NTI2YzdjZTY3MDY1YjhlMjZkYmI5NDQ1MSIsImh0dSI6Imh0dHBzOi8vZXJvZ2F0b3JlLmV4YW1wbGUvZW50ZS1leGFtcGxlL3YxIiwiaWF0IjoxNzYyMjYyNjE2fQ.kvXh8H9B5DWCNlWyNB_PzRH217j1NHnIkE_55WnEixt2RbQTGrCS6AFAznREA85dzqwAAaHb_qHtDc5BR0lLmQ</span>
<span class="na">Agid-JWT-Signature</span><span class="o">:</span> <span class="l">eyJhbGciOiJFUzI1NiIsImtpZCI6ImQ0YzNiMmExLTk4NzYtNTQzMi0xMGZlLWRjYmE5ODc2NTQzMiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiI5YThiN2M2ZC1lNWY0LWczaDItaTFqMC1rbG1ub3BxcnN0dXYiLCJzdWIiOiI5YThiN2M2ZC1lNWY0LWczaDItaTFqMC1rbG1ub3BxcnN0dXYiLCJhdWQiOiJodHRwczovL2Vyb2dhdG9yZS5leGFtcGxlL2VudGUtZXhhbXBsZS92MSIsImlhdCI6MTczMzM5Nzg0MCwibmJmIjoxNzMzNDAxNjI4LCJleHAiOjE3MzM0MDE0NDAsImp0aSI6ImQzZjdiMmM5LTI3NGEtNDJiNy04ZjhkLTJlOWQ4YjE3MzRiMCIsInNpZ25lZF9oZWFkZXJzIjpbeyJkaWdlc3QiOiJTSEEtMjU2PTcyZTE4YmRkZGYxM2M5MTFiNGRkNTYyZWUyMTk3OWE1YzlmMjM1YzNhMDFiZDE0MjZlODU3ZDhjMWEyODJmNDEifSx7ImNvbnRlbnQtdHlwZSI6ImFwcGxpY2F0aW9uL2pzb24ifV19.DpuBNo2UgQhL7WLin4mpdZrbIpQq3tPvCX6HfktkxG7L5mk6a8OK1Hg0mQcZfFi3gelS-aL9kFS-6MoSy4csBg</span>
<span class="na">Digest</span><span class="o">:</span> <span class="l">SHA-256=72e18bdddf13c911b4dd562ee21979a5c9f235c3a01bd1426e857d8c1a282f41</span>
<span class="na">Agid-JWT-TrackingEvidence</span><span class="o">:</span> <span class="l">eyJhbGciOiJFUzI1NiIsImtpZCI6ImQ0YzNiMmExLTk4NzYtNTQzMi0xMGZlLWRjYmE5ODc2NTQzMiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiI4MjkxNGIzZi02MGIyLTQ1MjktYjRkNi0zZDRlNjdmMGE5MzMiLCJhdWQiOiJodHRwczovL2Vyb2dhdG9yZS5leGFtcGxlL2VudGUtZXhhbXBsZS92MSIsImV4cCI6MTczMzA1MjYwMCwibmJmIjoxNzMzMDM2NDUwLCJpYXQiOjE3MzMwMzY0MDAsImp0aSI6ImE0YjVjNmQ3LWU4ZjktYWJjZC1lZjEyLTM0NTY3ODkwMTIzNCIsImRub25jZSI6NjUyODQyNDIxMzY4NSwicHVycG9zZUlkIjoiYjJjM2Q0ZTUtZjZnNy1oOGk5LWowazEtbG1ubzEyMzQ1Njc4IiwidXNlcklEIjoiYThiN2M2ZDUtZTRmMy1nMmgxLWk5ajAta2xtbm9wcXJzdHV2IiwibG9hIjoic3Vic3RhbnRpYWwifQ.bhb3f3aWEuK-bZWjyKRWrJ4hYUWhw2SQ-yRz0kUFjPQTVagjXuTqyhxsHO4KXeSX9SivgaLSvw4n9BeZa7APbQ</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>

<span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;parameter1&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;value1&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;parameter2&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;value2&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p>L'Erogatore DEVE validare la <cite>DPoP proof</cite> [<span class="target" id="index-71"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc9449.html"><strong>RFC 9449</strong></a>].</p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>La validazione della <cite>DPoP proof</cite> è richiesta solo quando si rispetta l'implementazione <code class="docutils literal notranslate"><span class="pre">POP_DPoP</span></code>.</p>
</div>
<p>L'Erogatore DEVE validare il Voucher come segue:</p>
<blockquote>
<div><p>Header:</p>
<blockquote>
<div><ul class="simple">
<li><p>Assicurarsi che il claim <code class="docutils literal notranslate"><span class="pre">typ</span></code> sia presente e che il suo valore sia <code class="docutils literal notranslate"><span class="pre">at+jwt</span></code>.</p></li>
</ul>
</div></blockquote>
<p>Firma:</p>
<blockquote>
<div><ul class="simple">
<li><p>Reperire l'insieme di chiavi pubbliche pubblicate all'Endpoint .well-known. Da questo insieme, selezionare la chiave pubblica il cui identificatore corrisponde al valore del parametro header <code class="docutils literal notranslate"><span class="pre">kid</span></code> nel Voucher.</p></li>
<li><p>Validare la firma dell'<code class="docutils literal notranslate"><span class="pre">access_token</span></code> utilizzando la chiave pubblica recuperata e l'algoritmo specificato dal parametro header <code class="docutils literal notranslate"><span class="pre">alg</span></code>.</p></li>
</ul>
</div></blockquote>
<p>Payload:</p>
<blockquote>
<div><ul class="simple">
<li><p>Il claim <code class="docutils literal notranslate"><span class="pre">iss</span></code> DEVE identificare il dominio dell'Authorization Server PDND.</p></li>
<li><p>Il claim <code class="docutils literal notranslate"><span class="pre">sub</span></code> DEVE corrispondere al claim <code class="docutils literal notranslate"><span class="pre">client_id</span></code>.</p></li>
<li><p>Il claim <code class="docutils literal notranslate"><span class="pre">aud</span></code> DEVE corrispondere all'e-Service previsto.</p></li>
<li><p>In caso di implementazione <code class="docutils literal notranslate"><span class="pre">POP_DPoP</span></code>, il claim <code class="docutils literal notranslate"><span class="pre">cnf.jkt</span></code> DEVE corrispondere al SHA-256 Thumbprint della chiave pubblica DPoP nel claim <code class="docutils literal notranslate"><span class="pre">jwk</span></code> nella prova DPoP.</p></li>
</ul>
</div></blockquote>
</div></blockquote>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>Se l'Erogatore richiede maggiori informazioni sul contesto della richiesta, può interagire con l'API di Interoperabilità PDND passando il valore del <code class="docutils literal notranslate"><span class="pre">purposeId</span></code> come parametro.</p>
</div>
<p>L'Erogatore DEVE validare il JWT <code class="docutils literal notranslate"><span class="pre">TrackingEvidence</span></code> come segue:</p>
<blockquote>
<div><p>Header:</p>
<blockquote>
<div><ul class="simple">
<li><p>Assicurarsi che il claim <code class="docutils literal notranslate"><span class="pre">typ</span></code> sia presente e che il suo valore sia <code class="docutils literal notranslate"><span class="pre">JWT</span></code>.</p></li>
</ul>
</div></blockquote>
<p>Firma:</p>
<blockquote>
<div><ul class="simple">
<li><p>Ottenere la chiave pubblica del Fruitore corrispondente al parametro header <code class="docutils literal notranslate"><span class="pre">kid</span></code>, interagendo con l'API di Interoperabilità PDND.</p></li>
<li><p>Validare la firma del JWT utilizzando la chiave pubblica del Fruitore recuperata e l'algoritmo specificato dal parametro header <code class="docutils literal notranslate"><span class="pre">alg</span></code>.</p></li>
</ul>
</div></blockquote>
<p>Payload:</p>
<blockquote>
<div><ul class="simple">
<li><p>Il claim <code class="docutils literal notranslate"><span class="pre">iss</span></code> DEVE identificare il Client del Fruitore.</p></li>
<li><p>Il claim <code class="docutils literal notranslate"><span class="pre">aud</span></code> DEVE identificare l'Erogatore.</p></li>
</ul>
</div></blockquote>
</div></blockquote>
<p>Inoltre, l'Erogatore DEVE assicurarsi che l'hash del JWT <code class="docutils literal notranslate"><span class="pre">TrackingEvidence</span></code> corrisponda al valore del claim <code class="docutils literal notranslate"><span class="pre">digest.value</span></code> contenuto nel payload <code class="docutils literal notranslate"><span class="pre">access_token</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>La validazione del JWT <code class="docutils literal notranslate"><span class="pre">TrackingEvidence</span></code> è richiesta solo quando si rispetta il pattern di sicurezza <code class="docutils literal notranslate"><span class="pre">AUDIT_REST_02</span></code> o l'implementazione <code class="docutils literal notranslate"><span class="pre">POP_TPoP</span></code>.</p>
</div>
<p>L'Erogatore DEVE validare il JWT <code class="docutils literal notranslate"><span class="pre">Signature</span></code> come segue:</p>
<blockquote>
<div><p>Header:</p>
<blockquote>
<div><ul class="simple">
<li><p>Assicurarsi che il claim <code class="docutils literal notranslate"><span class="pre">typ</span></code> sia presente e che il suo valore sia <code class="docutils literal notranslate"><span class="pre">JWT</span></code>.</p></li>
</ul>
</div></blockquote>
<p>Firma:</p>
<blockquote>
<div><ul class="simple">
<li><p>Validare la firma del JWT utilizzando la chiave pubblica del Fruitore recuperata e l'algoritmo specificato dal parametro header <code class="docutils literal notranslate"><span class="pre">alg</span></code>.</p></li>
</ul>
</div></blockquote>
<p>Payload:</p>
<blockquote>
<div><ul class="simple">
<li><p>I claim <code class="docutils literal notranslate"><span class="pre">iss</span></code> e <code class="docutils literal notranslate"><span class="pre">sub</span></code> DEVONO identificare il Client del Fruitore.</p></li>
<li><p>Il claim <code class="docutils literal notranslate"><span class="pre">aud</span></code> DEVE identificare l'Erogatore.</p></li>
</ul>
</div></blockquote>
</div></blockquote>
<p>Inoltre, l'Erogatore DEVE validare l'integrità della <cite>e-Service Request</cite>, verificando che:</p>
<blockquote>
<div><ul class="simple">
<li><p>Il claim <code class="docutils literal notranslate"><span class="pre">signed_headers.content-type</span></code> corrisponda al valore dell'header HTTP <code class="docutils literal notranslate"><span class="pre">Content-Type</span></code> della <cite>e-Service Request</cite>.</p></li>
<li><p>Il claim <code class="docutils literal notranslate"><span class="pre">signed_headers.digest</span></code> corrisponda al valore del digest del payload della <cite>e-Service Request</cite>, nonché al valore dell'header HTTP <code class="docutils literal notranslate"><span class="pre">Digest</span></code> della <cite>e-Service Request</cite>.</p></li>
</ul>
</div></blockquote>
<p>Se uno qualsiasi dei controlli precedenti fallisce, l'Erogatore DEVE rifiutare la richiesta.</p>
<p><strong>Passo 4 (Risposta):</strong> Qualora i controlli abbiano successo, l'Erogatore fornisce al Fruitore i dati richiesti.</p>
<div class="literal-block-wrapper docutils container" id="code-usage-flow-response">
<div class="code-block-caption"><span class="caption-number">Listato 15.26 </span><span class="caption-text">Esempio non normativo della <cite>e-Service Response</cite></span><a class="headerlink" href="#code-usage-flow-response" title="Link to this code">¶</a></div>
<div class="highlight-http notranslate"><div class="highlight"><pre><span></span><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/jwt</span>

eyJhbGciOiJFUzI1NiIsImtpZCI6IjI4MDJhNjktMTYwNC00MjYxLTkyNDYtMjE0NTNlMjA2NThlIiwidHlwIjoiSldUIn0.eyJpc3MiOiJodHRwczovL2Vyb2dhdG9yZS5leGFtcGxlL2VudGUtZXhhbXBsZS92MSIsImF1ZCI6IjlhOGI3YzZkLWU1ZjQtZzNoMi1pMWowLWtsbW5vcHFyc3R1diIsImV4cCI6MTczMzQwMTc4NSwibmJmIjoxNzMzNDAxMzg3LCJpYXQiOjE3MzM0MDEyNTYsImp0aSI6Ijk5NzUzMmUtODcxYS00OTY5LTk5OTktMTIzNDU2Nzg5YWJjIiwicmVxdWVzdGVkRmllbGQxIjoidmFsdWUxIiwicmVxdWVzdGVkRmllbGQyIjoidmFsdWUyIiwicmVxdWVzdGVkRmllbGQzIjoidmFsdWUzIn0.OZSn693I-oCvvq3RnFW-9HeUWE7J1hri-lyae8CLt2JTbzKPCnWg7f6AmzR-euXYKdRWpofZkhpux7TlYG9RwA
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="code-usage-flow-response-jwt-header">
<div class="code-block-caption"><span class="caption-number">Listato 15.27 </span><span class="caption-text">Esempio non normativo dell'header JWT della <cite>e-Service Response</cite></span><a class="headerlink" href="#code-usage-flow-response-jwt-header" title="Link to this code">¶</a></div>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;alg&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ES256&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;kid&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2802a69-1604-4261-9246-21453e20658e&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;typ&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;JWT&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="code-usage-flow-response-jwt-payload">
<div class="code-block-caption"><span class="caption-number">Listato 15.28 </span><span class="caption-text">Esempio non normativo del payload JWT della <cite>e-Service Response</cite></span><a class="headerlink" href="#code-usage-flow-response-jwt-payload" title="Link to this code">¶</a></div>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;iss&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://erogatore.example/ente-example/v1&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;aud&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;9a8b7c6d-e5f4-g3h2-i1j0-klmnopqrstuv&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;exp&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1733401785</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;nbf&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1733401387</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;iat&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1733401256</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;jti&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;997532e-871a-4969-9999-123456789abc&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;requestedField1&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;value1&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;requestedField2&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;value2&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;requestedField3&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;value3&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p>Il Fruitore DEVE eseguire i seguenti passaggi per validare il JWT della <cite>e-Service Response</cite>:</p>
<blockquote>
<div><p>Header:</p>
<ul class="simple">
<li><p>Assicurarsi che il claim <code class="docutils literal notranslate"><span class="pre">typ</span></code> sia presente e che il suo valore sia <code class="docutils literal notranslate"><span class="pre">JWT</span></code>.</p></li>
</ul>
<p>Firma:</p>
<ul class="simple">
<li><p>Ottenere la chiave pubblica dell'Erogatore corrispondente al parametro header <code class="docutils literal notranslate"><span class="pre">kid</span></code>, interagendo con l'API di Interoperabilità PDND.</p></li>
<li><p>Validare la firma del JWT utilizzando la chiave pubblica dell'Erogatore recuperata e l'algoritmo specificato dal parametro header <code class="docutils literal notranslate"><span class="pre">alg</span></code>.</p></li>
</ul>
<p>Payload:</p>
<ul class="simple">
<li><p>Il claim <code class="docutils literal notranslate"><span class="pre">iss</span></code> DEVE identificare l'Erogatore.</p></li>
<li><p>Il claim <code class="docutils literal notranslate"><span class="pre">aud</span></code> DEVE identificare il Client del Fruitore stesso.</p></li>
</ul>
</div></blockquote>
</section>
<section id="endpoint-e-service">
<h3><span class="section-number">15.2.4.3. </span>Endpoint e-Service<a class="headerlink" href="#endpoint-e-service" title="Link to this heading">¶</a></h3>
<section id="richiesta-e-service">
<h4><span class="section-number">15.2.4.3.1. </span>Richiesta (e-Service)<a class="headerlink" href="#richiesta-e-service" title="Link to this heading">¶</a></h4>
<p>La <cite>e-Service Request</cite> DEVE includere i seguenti parametri di header HTTP (se non diversamente specificato):</p>
<table class="longtable docutils align-default">
<colgroup>
<col style="width: 20.0%" />
<col style="width: 60.0%" />
<col style="width: 20.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><strong>Parametro</strong></p></th>
<th class="head"><p><strong>Descrizione</strong></p></th>
<th class="head"><p><strong>Riferimento</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>Authorization</strong></p></td>
<td><p>Voucher rilasciato dall'Authorization Server PDND.</p></td>
<td><p>[<span class="target" id="index-72"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc9449.html"><strong>RFC 9449</strong></a>], [<a class="reference external" href="https://www.agid.gov.it/sites/agid/files/2024-05/linee_guida_interoperabilit_tecnica_pa.pdf">MODI</a>], [<a class="reference external" href="https://www.agid.gov.it/sites/agid/files/2024-06/Linee_guida_infrastruttura_interoperabilita_pdnd.pdf">PDND</a>]</p></td>
</tr>
<tr class="row-odd"><td><p><strong>DPoP</strong></p></td>
<td><p>JWT di <cite>DPoP proof</cite>, per rispettare il pattern di sicurezza <code class="docutils literal notranslate"><span class="pre">REST_JWS_2021_POP</span></code>. È obbligatorio solo quando si segue l'implementazione <code class="docutils literal notranslate"><span class="pre">POP_DPoP</span></code>.</p></td>
<td><p>[<span class="target" id="index-73"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc9449.html"><strong>RFC 9449</strong></a>], [<a class="reference external" href="https://www.agid.gov.it/sites/agid/files/2024-06/Linee_guida_infrastruttura_interoperabilita_pdnd.pdf">PDND</a>]</p></td>
</tr>
<tr class="row-even"><td><p><strong>Agid-JWT-Signature</strong></p></td>
<td><p>JWT contenente la firma delle intestazioni del messaggio la cui integrità deve essere garantita, per rispettare il pattern di sicurezza <code class="docutils literal notranslate"><span class="pre">INTEGRITY_REST_02</span></code>.</p></td>
<td><p>[<a class="reference external" href="https://www.agid.gov.it/sites/agid/files/2024-05/linee_guida_interoperabilit_tecnica_pa.pdf">MODI</a>]</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Digest</strong></p></td>
<td><p>Digest del payload del messaggio, per rispettare il pattern di sicurezza <code class="docutils literal notranslate"><span class="pre">INTEGRITY_REST_02</span></code>. Secondo <span class="target" id="index-74"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc3230.html"><strong>RFC 3230</strong></a>, il formato DEVE essere il seguente: <code class="docutils literal notranslate"><span class="pre">&lt;digest-algorithm&gt;=&lt;encoded</span> <span class="pre">digest</span> <span class="pre">output&gt;</span></code>.</p></td>
<td><p>[<span class="target" id="index-75"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc3230.html"><strong>RFC 3230</strong></a>], [<a class="reference external" href="https://www.agid.gov.it/sites/agid/files/2024-05/linee_guida_interoperabilit_tecnica_pa.pdf">MODI</a>]</p></td>
</tr>
<tr class="row-even"><td><p><strong>Agid-JWT-TrackingEvidence</strong></p></td>
<td><p>JWT contenente i dati tracciati nel dominio del Fruitore. È obbligatorio solo quando si rispetta <code class="docutils literal notranslate"><span class="pre">AUDIT_REST_02</span></code> o l'implementazione <code class="docutils literal notranslate"><span class="pre">POP_TPoP</span></code>.</p></td>
<td><p>[<a class="reference external" href="https://www.agid.gov.it/sites/agid/files/2024-05/linee_guida_interoperabilit_tecnica_pa.pdf">MODI</a>]</p></td>
</tr>
</tbody>
</table>
<p>Il JWT <code class="docutils literal notranslate"><span class="pre">Signature</span></code>, contenuto nell'header HTTP <code class="docutils literal notranslate"><span class="pre">Agid-JWT-Signature</span></code>, DEVE includere i seguenti parametri nel JOSE header:</p>
<table class="longtable docutils align-default">
<colgroup>
<col style="width: 20.0%" />
<col style="width: 60.0%" />
<col style="width: 20.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><strong>Parametro</strong></p></th>
<th class="head"><p><strong>Descrizione</strong></p></th>
<th class="head"><p><strong>Riferimento</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>alg</strong></p></td>
<td><p>Identificativo di un algoritmo di firma digitale.</p></td>
<td><p>[<span class="target" id="index-76"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7515.html"><strong>RFC 7515</strong></a>]</p></td>
</tr>
<tr class="row-odd"><td><p><strong>kid</strong></p></td>
<td><p>Identificativo univoco del JWK utilizzata dal Fruitore per firmare il JWT.</p></td>
<td><p>[<span class="target" id="index-77"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7515.html"><strong>RFC 7515</strong></a>]</p></td>
</tr>
<tr class="row-even"><td><p><strong>typ</strong></p></td>
<td><p>DEVE essere impostato su <code class="docutils literal notranslate"><span class="pre">JWT</span></code>.</p></td>
<td><p>[<span class="target" id="index-78"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7515.html"><strong>RFC 7515</strong></a>], [<span class="target" id="index-79"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7519.html"><strong>RFC 7519</strong></a>]</p></td>
</tr>
</tbody>
</table>
<p>Il JWT <code class="docutils literal notranslate"><span class="pre">Signature</span></code>, contenuto nell'header HTTP <code class="docutils literal notranslate"><span class="pre">Agid-JWT-Signature</span></code>, DEVE includere i seguenti claim nel payload:</p>
<table class="longtable docutils align-default">
<colgroup>
<col style="width: 20.0%" />
<col style="width: 60.0%" />
<col style="width: 20.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><strong>Claim</strong></p></th>
<th class="head"><p><strong>Descrizione</strong></p></th>
<th class="head"><p><strong>Riferimento</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>iss</strong></p></td>
<td><p>DEVE essere impostato sullo stesso valore di <code class="docutils literal notranslate"><span class="pre">client_id</span></code>.</p></td>
<td><p>[<span class="target" id="index-80"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7519.html"><strong>RFC 7519</strong></a>]</p></td>
</tr>
<tr class="row-odd"><td><p><strong>sub</strong></p></td>
<td><p>DEVE essere impostato sullo stesso valore di <code class="docutils literal notranslate"><span class="pre">client_id</span></code>.</p></td>
<td><p>[<span class="target" id="index-81"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7519.html"><strong>RFC 7519</strong></a>]</p></td>
</tr>
<tr class="row-even"><td><p><strong>aud</strong></p></td>
<td><p>Identificativo dell'Erogatore.</p></td>
<td><p>[<span class="target" id="index-82"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7519.html"><strong>RFC 7519</strong></a>]</p></td>
</tr>
<tr class="row-odd"><td><p><strong>exp</strong></p></td>
<td><p>Timestamp UNIX che rappresenta l'istante di scadenza del JWT.</p></td>
<td><p>[<span class="target" id="index-83"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7519.html"><strong>RFC 7519</strong></a>]</p></td>
</tr>
<tr class="row-even"><td><p><strong>nbf</strong></p></td>
<td><p>Timestamp UNIX che rappresenta il primo istante di validità del JWT (opzionale).</p></td>
<td><p>[<span class="target" id="index-84"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7519.html"><strong>RFC 7519</strong></a>]</p></td>
</tr>
<tr class="row-odd"><td><p><strong>iat</strong></p></td>
<td><p>Timestamp UNIX che rappresenta l'istante di emissione del JWT.</p></td>
<td><p>[<span class="target" id="index-85"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7519.html"><strong>RFC 7519</strong></a>]</p></td>
</tr>
<tr class="row-even"><td><p><strong>jti</strong></p></td>
<td><p>Identificativo univoco del JWT per prevenire attacchi di replay.</p></td>
<td><p>[<span class="target" id="index-86"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7519.html"><strong>RFC 7519</strong></a>]</p></td>
</tr>
<tr class="row-odd"><td><p><strong>signed_headers</strong></p></td>
<td><p>Oggetto JSON contenente le intestazioni firmate la cui integrità deve essere protetta, per rispettare <code class="docutils literal notranslate"><span class="pre">INTEGRITY_REST_02</span></code>. DEVE contenere i seguenti claim:</p>
<ul class="simple">
<li><p><strong>digest</strong>: stringa JSON che rappresenta la firma dell'header HTTP <code class="docutils literal notranslate"><span class="pre">Digest</span></code></p></li>
<li><p><strong>content-type</strong>: stringa JSON che rappresenta la firma dell'header HTTP <code class="docutils literal notranslate"><span class="pre">Content-Type</span></code></p></li>
</ul>
</td>
<td><p>[<a class="reference external" href="https://www.agid.gov.it/sites/agid/files/2024-05/linee_guida_interoperabilit_tecnica_pa.pdf">MODI</a>]</p></td>
</tr>
</tbody>
</table>
<p>Se presente, il JWT <code class="docutils literal notranslate"><span class="pre">TrackingEvidence</span></code>, contenuto nell'header HTTP <code class="docutils literal notranslate"><span class="pre">Agid-JWT-TrackingEvidence</span></code>, DEVE includere i seguenti parametri nel JOSE header:</p>
<table class="longtable docutils align-default">
<colgroup>
<col style="width: 20.0%" />
<col style="width: 60.0%" />
<col style="width: 20.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><strong>Parametro</strong></p></th>
<th class="head"><p><strong>Descrizione</strong></p></th>
<th class="head"><p><strong>Riferimento</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>alg</strong></p></td>
<td><p>Identificativo di un algoritmo di firma digitale.</p></td>
<td><p>[<span class="target" id="index-87"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7515.html"><strong>RFC 7515</strong></a>]</p></td>
</tr>
<tr class="row-odd"><td><p><strong>kid</strong></p></td>
<td><p>Identificativo univoco del JWK utilizzato dal Fruitore per firmare il JWT.</p></td>
<td><p>[<span class="target" id="index-88"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7515.html"><strong>RFC 7515</strong></a>]</p></td>
</tr>
<tr class="row-even"><td><p><strong>typ</strong></p></td>
<td><p>DEVE essere impostato su <code class="docutils literal notranslate"><span class="pre">JWT</span></code>.</p></td>
<td><p>[<span class="target" id="index-89"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7515.html"><strong>RFC 7515</strong></a>], [<span class="target" id="index-90"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7519.html"><strong>RFC 7519</strong></a>]</p></td>
</tr>
</tbody>
</table>
<p>Se presente, il JWT <code class="docutils literal notranslate"><span class="pre">TrackingEvidence</span></code>, contenuto nell'header HTTP <code class="docutils literal notranslate"><span class="pre">Agid-JWT-TrackingEvidence</span></code>, DEVE includere i seguenti claim nel payload:</p>
<table class="longtable docutils align-default">
<colgroup>
<col style="width: 20.0%" />
<col style="width: 60.0%" />
<col style="width: 20.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><strong>Claim</strong></p></th>
<th class="head"><p><strong>Descrizione</strong></p></th>
<th class="head"><p><strong>Riferimento</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>iss</strong></p></td>
<td><p>DEVE essere impostato sullo stesso valore di <code class="docutils literal notranslate"><span class="pre">client_id</span></code>.</p></td>
<td><p>[<span class="target" id="index-91"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7519.html"><strong>RFC 7519</strong></a>]</p></td>
</tr>
<tr class="row-odd"><td><p><strong>aud</strong></p></td>
<td><p>Identificativo dell'Erogatore.</p></td>
<td><p>[<span class="target" id="index-92"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7519.html"><strong>RFC 7519</strong></a>]</p></td>
</tr>
<tr class="row-even"><td><p><strong>exp</strong></p></td>
<td><p>Timestamp UNIX che rappresenta l'istante di scadenza del JWT.</p></td>
<td><p>[<span class="target" id="index-93"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7519.html"><strong>RFC 7519</strong></a>]</p></td>
</tr>
<tr class="row-odd"><td><p><strong>nbf</strong></p></td>
<td><p>Timestamp UNIX che rappresenta il primo istante di validità del JWT (opzionale).</p></td>
<td><p>[<span class="target" id="index-94"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7519.html"><strong>RFC 7519</strong></a>]</p></td>
</tr>
<tr class="row-even"><td><p><strong>iat</strong></p></td>
<td><p>Timestamp UNIX che rappresenta l'istante di emissione del JWT.</p></td>
<td><p>[<span class="target" id="index-95"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7519.html"><strong>RFC 7519</strong></a>]</p></td>
</tr>
<tr class="row-odd"><td><p><strong>jti</strong></p></td>
<td><p>Identificativo univoco del JWT per prevenire attacchi di replay.</p></td>
<td><p>[<span class="target" id="index-96"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7519.html"><strong>RFC 7519</strong></a>]</p></td>
</tr>
<tr class="row-even"><td><p><strong>purposeId</strong></p></td>
<td><p>Identificativo dello scopo registrato nella Piattaforma PDND, associato all'e-Service previsto.</p></td>
<td><p>[<a class="reference external" href="https://www.agid.gov.it/sites/agid/files/2024-05/linee_guida_interoperabilit_tecnica_pa.pdf">MODI</a>]</p></td>
</tr>
<tr class="row-odd"><td><p><strong>dnonce</strong></p></td>
<td><p>DEVE essere una stringa casuale composta da numeri interi e con una lunghezza di 13 cifre.</p></td>
<td><p>[<a class="reference external" href="https://www.agid.gov.it/sites/agid/files/2024-05/linee_guida_interoperabilit_tecnica_pa.pdf">MODI</a>]</p></td>
</tr>
</tbody>
</table>
<p>Quando si rispetta il pattern di sicurezza <code class="docutils literal notranslate"><span class="pre">AUDIT_REST_02</span></code>, il payload <code class="docutils literal notranslate"><span class="pre">TrackingEvidence</span></code> DEVE contenere anche i dati tracciati concordati con l'Erogatore.</p>
</section>
<section id="risposta-e-service">
<h4><span class="section-number">15.2.4.3.2. </span>Risposta (e-Service)<a class="headerlink" href="#risposta-e-service" title="Link to this heading">¶</a></h4>
<p>La <cite>e-Service Response</cite> è un JWT serializzato in formato <code class="docutils literal notranslate"><span class="pre">application/jwt</span></code>.</p>
<p>Il JWT della <cite>e-Service Response</cite> DEVE includere i seguenti parametri nel JOSE header:</p>
<table class="longtable docutils align-default">
<colgroup>
<col style="width: 20.0%" />
<col style="width: 60.0%" />
<col style="width: 20.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><strong>Parametro</strong></p></th>
<th class="head"><p><strong>Descrizione</strong></p></th>
<th class="head"><p><strong>Riferimento</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>alg</strong></p></td>
<td><p>Identificativo di un algoritmo di firma digitale.</p></td>
<td><p>[<span class="target" id="index-97"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7515.html"><strong>RFC 7515</strong></a>]</p></td>
</tr>
<tr class="row-odd"><td><p><strong>kid</strong></p></td>
<td><p>Identificativo univoco del JWK utilizzato dall'Erogatore per firmare il JWT.</p></td>
<td><p>[<span class="target" id="index-98"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7515.html"><strong>RFC 7515</strong></a>]</p></td>
</tr>
<tr class="row-even"><td><p><strong>typ</strong></p></td>
<td><p>DEVE essere impostato su <code class="docutils literal notranslate"><span class="pre">JWT</span></code>.</p></td>
<td><p>[<span class="target" id="index-99"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7515.html"><strong>RFC 7515</strong></a>], [<span class="target" id="index-100"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7519.html"><strong>RFC 7519</strong></a>]</p></td>
</tr>
</tbody>
</table>
<p>Il JWT della <cite>e-Service Response</cite> DEVE includere i seguenti claim nel payload:</p>
<table class="longtable docutils align-default">
<colgroup>
<col style="width: 20.0%" />
<col style="width: 60.0%" />
<col style="width: 20.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><strong>Claim</strong></p></th>
<th class="head"><p><strong>Descrizione</strong></p></th>
<th class="head"><p><strong>Riferimento</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>iss</strong></p></td>
<td><p>Identificativo dell'e-Service.</p></td>
<td><p>[<span class="target" id="index-101"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7519.html"><strong>RFC 7519</strong></a>]</p></td>
</tr>
<tr class="row-odd"><td><p><strong>aud</strong></p></td>
<td><p>Identificativo del Fruitore.</p></td>
<td><p>[<span class="target" id="index-102"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7519.html"><strong>RFC 7519</strong></a>]</p></td>
</tr>
<tr class="row-even"><td><p><strong>exp</strong></p></td>
<td><p>Timestamp UNIX che rappresenta l'istante di scadenza del JWT.</p></td>
<td><p>[<span class="target" id="index-103"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7519.html"><strong>RFC 7519</strong></a>]</p></td>
</tr>
<tr class="row-odd"><td><p><strong>nbf</strong></p></td>
<td><p>Timestamp UNIX che rappresenta il primo istante di validità del JWT (opzionale).</p></td>
<td><p>[<span class="target" id="index-104"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7519.html"><strong>RFC 7519</strong></a>]</p></td>
</tr>
<tr class="row-even"><td><p><strong>iat</strong></p></td>
<td><p>Timestamp UNIX che rappresenta l'istante di emissione del JWT.</p></td>
<td><p>[<span class="target" id="index-105"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7519.html"><strong>RFC 7519</strong></a>]</p></td>
</tr>
<tr class="row-odd"><td><p><strong>jti</strong></p></td>
<td><p>Identificativo univoco del JWT per prevenire attacchi di replay.</p></td>
<td><p>[<span class="target" id="index-106"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7523.html"><strong>RFC 7523</strong></a>]</p></td>
</tr>
</tbody>
</table>
<p>Il payload del JWT della <cite>e-Service Response</cite> include specifici claim relativi ai dati forniti al Fruitore.</p>
<p>Se si verificano errori durante la validazione della <cite>e-Service Request</cite>, l'Endpoint e-Service DEVE restituire un errore, la cui struttura dipende dalla natura dell'errore.</p>
<p>In caso di problemi di autenticazione (cioè, Voucher non valido o scaduto), la risposta DEVE aderire al formato di errore definito in <span class="target" id="index-107"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc6750.html#section-3"><strong>RFC 6750#section-3</strong></a> e <span class="target" id="index-108"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc9449.html#section-7.1"><strong>RFC 9449#section-7.1</strong></a>, con specifico riferimento all'uso del parametro di header <code class="docutils literal notranslate"><span class="pre">WWW-Authenticate</span></code>.</p>
<div class="literal-block-wrapper docutils container" id="code-usage-endpoint-eservice-error-401">
<div class="code-block-caption"><span class="caption-number">Listato 15.29 </span><span class="caption-text">Esempio non normativo di una <cite>e-Service Error Response</cite> in caso di errori 401</span><a class="headerlink" href="#code-usage-endpoint-eservice-error-401" title="Link to this code">¶</a></div>
<div class="highlight-http notranslate"><div class="highlight"><pre><span></span><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">401</span> <span class="ne">Unauthorized</span>
<span class="na">WWW-Authenticate</span><span class="o">:</span> <span class="l">DPoP error=&quot;invalid_token&quot;, error_description=&quot;The access token expired&quot;</span>
</pre></div>
</div>
</div>
<p>Per tutti gli altri errori, la risposta DEVE aderire al formato di errore definito in <span class="target" id="index-109"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc6749.html#section-5.2"><strong>RFC 6749#section-5.2</strong></a>. La risposta DEVE utilizzare <code class="docutils literal notranslate"><span class="pre">application/json</span></code> come <code class="docutils literal notranslate"><span class="pre">Content-Type</span></code> e DEVE includere i seguenti parametri:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">error</span></code>: Il codice di errore.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">error_description</span></code>: Testo in forma leggibile dall'uomo che fornisce ulteriori dettagli per chiarire la natura dell'errore incontrato.</p></li>
</ul>
</div></blockquote>
<div class="literal-block-wrapper docutils container" id="code-usage-endpoint-eservice-error">
<div class="code-block-caption"><span class="caption-number">Listato 15.30 </span><span class="caption-text">Esempio non normativo di una <cite>e-Service Error Response</cite> in caso di altri errori</span><a class="headerlink" href="#code-usage-endpoint-eservice-error" title="Link to this code">¶</a></div>
<div class="highlight-http notranslate"><div class="highlight"><pre><span></span><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">400</span> <span class="ne">Bad Request</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>

<span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;invalid_request&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;error_description&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;The Agid-JWT-Signature header parameter is missing.&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p>La seguente tabella elenca gli HTTP Status Code e i relativi codici di errore che DEVONO essere supportati per la risposta di errore:</p>
<table class="longtable docutils align-default">
<colgroup>
<col style="width: 20.0%" />
<col style="width: 20.0%" />
<col style="width: 60.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><strong>HTTP Status Code</strong></p></th>
<th class="head"><p><strong>Codice di Errore</strong></p></th>
<th class="head"><p><strong>Descrizione</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">400</span> <span class="pre">Bad</span> <span class="pre">Request</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">invalid_request</span></code></p></td>
<td><p>La richiesta non può essere soddisfatta perché mancano parametri richiesti, contiene parametri non validi o è in qualche modo malformata [<span class="target" id="index-110"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc6750.html#section-3.1"><strong>RFC 6750#section-3.1</strong></a>].</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">400</span> <span class="pre">Bad</span> <span class="pre">Request</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">invalid_dpop_proof</span></code></p></td>
<td><p>La richiesta non può essere soddisfatta perché contiene una <em>DPoP proof</em> non valida [<span class="target" id="index-111"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc9449.html#section-5"><strong>RFC 9449#section-5</strong></a>].</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">401</span> <span class="pre">Unauthorized</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">invalid_token</span></code></p></td>
<td><p>La richiesta non può essere soddisfatta perché il Voucher è scaduto, revocato o in qualche modo malformato [<span class="target" id="index-112"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc6750.html#section-3.1"><strong>RFC 6750#section-3.1</strong></a>].</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">500</span> <span class="pre">Internal</span> <span class="pre">Server</span> <span class="pre">Error</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">server_error</span></code></p></td>
<td><p>La richiesta non può essere soddisfatta perché l'Endpoint e-Service ha riscontrato un problema interno.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">503</span> <span class="pre">Service</span> <span class="pre">Unavailable</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">temporarily_unavailable</span></code></p></td>
<td><p>La richiesta non può essere soddisfatta perché l'Endpoint e-Service è temporaneamente non disponibile (ad esempio, a causa di manutenzione o sovraccarico).</p></td>
</tr>
</tbody>
</table>
</section>
</section>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
    
        <div id="show_right_sidebar">
            <p><a class="toggle_right_sidebar" href="#"><span class="icon">&lt;</span><span>Page contents</span></a></p>
        </div>

        <div id="right_sidebar">
            <p><a class="toggle_right_sidebar" href="#"><span class="icon">&gt;</span><span>Page contents:</span></a></p>
            <div class="page_toc">
                <ul>
<li><a class="reference internal" href="#">15.2. e-Service PDND</a><ul>
<li><a class="reference internal" href="#requisiti-e-pattern-di-sicurezza">15.2.1. Requisiti e Pattern di Sicurezza</a></li>
<li><a class="reference internal" href="#emissione-del-voucher-pdnd">15.2.2. Emissione del Voucher PDND</a><ul>
<li><a class="reference internal" href="#voucher-pdnd-per-e-service">15.2.2.1. Voucher PDND per e-Service</a><ul>
<li><a class="reference internal" href="#prerequisiti-per-il-voucher-pdnd-per-e-service">15.2.2.1.1. Prerequisiti per il Voucher PDND per e-Service</a></li>
<li><a class="reference internal" href="#flusso-del-voucher-pdnd-per-e-service">15.2.2.1.2. Flusso del Voucher PDND per e-Service</a></li>
</ul>
</li>
<li><a class="reference internal" href="#voucher-pdnd-per-api-di-interoperabilita">15.2.2.2. Voucher PDND per API di Interoperabilità</a><ul>
<li><a class="reference internal" href="#prerequisiti-per-il-voucher-pdnd-per-api-di-interoperabilita">15.2.2.2.1. Prerequisiti per il Voucher PDND per API di Interoperabilità</a></li>
<li><a class="reference internal" href="#flusso-del-voucher-per-api-di-interoperabilita">15.2.2.2.2. Flusso del Voucher per API di Interoperabilità</a></li>
</ul>
</li>
<li><a class="reference internal" href="#endpoint-authorization-server-pdnd">15.2.2.3. Endpoint Authorization Server PDND</a><ul>
<li><a class="reference internal" href="#richiesta-voucher-pdnd">15.2.2.3.1. Richiesta (Voucher PDND)</a></li>
<li><a class="reference internal" href="#risposta-voucher-pdnd">15.2.2.3.2. Risposta (Voucher PDND)</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#reperimento-delle-chiavi">15.2.3. Reperimento delle Chiavi</a><ul>
<li><a class="reference internal" href="#chiavi-dell-authorization-server-pdnd">15.2.3.1. Chiavi dell'Authorization Server PDND</a></li>
<li><a class="reference internal" href="#endpoint-well-known-dell-authorization-server-pdnd">15.2.3.2. Endpoint .well-known dell'Authorization Server PDND</a><ul>
<li><a class="reference internal" href="#richiesta-chiavi-dell-authorization-server-pdnd">15.2.3.2.1. Richiesta (Chiavi dell'Authorization Server PDND)</a></li>
<li><a class="reference internal" href="#risposta-chiavi-dell-authorization-server-pdnd">15.2.3.2.2. Risposta (Chiavi dell'Authorization Server PDND)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#chiavi-degli-aderenti">15.2.3.3. Chiavi degli Aderenti</a><ul>
<li><a class="reference internal" href="#prerequisiti-per-il-reperimento-delle-chiavi-degli-aderenti">15.2.3.3.1. Prerequisiti per il Reperimento delle Chiavi degli Aderenti</a></li>
<li><a class="reference internal" href="#flusso-di-reperimento-delle-chiavi-degli-aderenti">15.2.3.3.2. Flusso di Reperimento delle Chiavi degli Aderenti</a></li>
</ul>
</li>
<li><a class="reference internal" href="#endpoint-api-di-interoperabilita-pdnd">15.2.3.4. Endpoint API di Interoperabilità PDND</a><ul>
<li><a class="reference internal" href="#richiesta-chiave-da-api-di-interoperabilita-pdnd">15.2.3.4.1. Richiesta (Chiave da API di Interoperabilità PDND)</a></li>
<li><a class="reference internal" href="#risposta-chiave-da-api-di-interoperabilita-pdnd">15.2.3.4.2. Risposta (Chiave da API di Interoperabilità PDND)</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#utilizzo-dell-e-service">15.2.4. Utilizzo dell'e-Service</a><ul>
<li><a class="reference internal" href="#prerequisiti-per-l-utilizzo-dell-e-service">15.2.4.1. Prerequisiti per l'Utilizzo dell'e-Service</a></li>
<li><a class="reference internal" href="#flusso-di-utilizzo-dell-e-service">15.2.4.2. Flusso di Utilizzo dell'e-Service</a></li>
<li><a class="reference internal" href="#endpoint-e-service">15.2.4.3. Endpoint e-Service</a><ul>
<li><a class="reference internal" href="#richiesta-e-service">15.2.4.3.1. Richiesta (e-Service)</a></li>
<li><a class="reference internal" href="#risposta-e-service">15.2.4.3.2. Risposta (e-Service)</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

            </div>
        </div>
    

      <div class="clearer"></div>
    </div>
    <div class="button_nav_wrapper">
        <div class="button_nav">
            <div class="left">
                
                <a href="mobile-application-instance.html">
                    <span class="icon">&lt;</span><span><span class="section-number">15.1. </span>Istanza dell'Applicazione Mobile</span></a>
                
            </div>

            <div class="right">
                
                    <a href="test-plans.html"><span><span class="section-number">15.3. </span>Piani di Test</span><span class="icon">&gt;</span></a>
                
            </div>
        </div>
    </div>


    <div class="footer" role="contentinfo">
      Ultimo aggiornamento 30/05/2025.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.4.5.
    </div>

<p id="theme_credit"></p>
  </body>
</html>