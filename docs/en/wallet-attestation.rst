.. include:: ../common/common_definitions.rst

.. _wallet-attestation.rst:

Wallet Attestation Issuance
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
This section describes how the Wallet Provider issues a Wallet Attestation.

.. figure:: ../../images/wallet_instance_acquisition.svg
    :figwidth: 100%
    :align: center
    :target: https://www.plantuml.com/plantuml/svg/VLHDRnCn4BtxLupS0wqKBaXmA0ArgafRWL3K5hX4YcRNarqhc_5YpwQKNu-zAV4sc5vMiVtcuxrvaxCWw6NOT0e7SJniAlAgjOPWvPnKxfTwrKU0hMsFB4fXBSw3_XR8Qy00GuZu2GBq3-mw4hZX8CWrZIZiUtYE-aoFS2v24IJMCPpFRy8EYXBWAFJUSjDu8YvcdtktjOOyL5YlYSqOMjLhfLJgwFN7MF4KRkddG440WUa1N4z-LqnQb0Nx-6ez1K3OPPqsb8ZQBGgbtfMAdwUS5otLQx0hkF2FlRZ6Oz_Q6gxHcmVq18dOWk-nWMEjswVRvPeUbuADrYTW0-0MROTLHsgQ-OeuDPWQOg2-fKqyTX13eKVhKxxzxPYm7ogjP_3FjRVRM4Wfpqu8t9Py8Z6Byi3Hbvkhw_khsylBhsh7v51G6o093cu5qX9y8lDNDMG3hXAq35O2R4ZGeA0YDgdIdaoiawNNcbroWSw2ZcEAdn6PQSFAKsXpm0xpf4s-DJHDL1GmeklE4iiozRTiCRHwDCZTzVcRj--EzybcK9Jqf9ZqXNdFtNp1asa7sp3Au6C9-03fT5ngQGObXxoVtEPvvgPGmccHeKfFMR0KYjdGMfTO5Po_7zs3bRQKPmPbgZF8mYwuHEq_UeyAaTaLpCOl-thYiJjYymA1vuxBov2EvML8QttmzvNsmR8LYvtzJMPSWctyRTGGB3V52UQDo2x_dc9GA6jKU2oeNO8LzIyYotedlqx05vxAJfWiO5dcq3iETBYIqtECLMV4PjXqVm00

    Sequence Diagram for Wallet Attestation acquisition

**Step 1**: The User initiates a new operation that necessitates the acquisition of a Wallet Attestation.

**Steps 2-3**: The Wallet Instance MUST:

  1. Verify the existence of Cryptographic Hardware Keys. If none exist, Wallet Instance re-initialization is required.
  2. Generate an ephemeral asymmetric key pair for Wallet Attestation (``ephemeral_key_pub``, ``ephemeral_key_priv``), linking the public key to the attestation.
  3. Verify the Wallet Provider's federation membership and retrieve its metadata.


**Steps 4-6 (Nonce Retrieval)**: The Wallet Instance solicits a ``nonce`` from the :ref:`sec_ws_nonce_endpoint` of the Wallet Provider Backend. This ``nonce`` is required to be unpredictable and serves as the main defense against replay attacks. 
The ``nonce`` MUST be produced in a manner that ensures its single-use within a predetermined time frame.

Below is a non-normative example of a Nonce Request.

.. code-block:: http

    GET /nonce HTTP/1.1
    Host: wallet-provider.example.com

Upon a successful request, the Wallet Provider generates and returns the nonce value to the Wallet Instance. 
Below is a non-normative example of a Nonce Response.

.. code-block:: http

    HTTP/1.1 200 OK
    Content-Type: application/json

    {
      "nonce": "i4ThI2Jhbu81i8mqyWEuDG5t"
    }

**Step 7**: The Wallet Instance performs the following actions:

* Creates ``client_data``, a JSON object that includes the ``nonce`` and the thumbprint of ``ephemeral_key_pub`` JWK.
* Computes ``client_data_hash`` by applying the ``SHA256`` algorithm to the ``client_data``.

Below is a non-normative example of the ``client_data`` JSON object.

.. code-block:: json

  {
    "nonce": "i4ThI2Jhbu81i8mqyWEuDG5t",
    "jwk_thumbprint": "vbeXJksM45xphtANnCiG6mCyuU4jfGNzopGuKvogg9c"
  }

**Steps 8-10**: The Wallet Instance:

*  produces an ``hardware_signature`` value by signing the ``client_data_hash`` with the Wallet Hardware's private key, serving as a proof of possession for the Cryptographic Hardware Keys.
*  requests the Key Attestation API to create an ``key_attestation`` value linked to the ``client_data_hash``.
*  receives a signed ``key_attestation`` value from the Key Attestation API, authenticated by the OEM.

.. note:: ``key_attestation`` is a custom payload generated by Key Attestation API, signed by device OEM and encoded in base64 to have uniformity between different devices.

**Steps 11-12 (Wallet Attestation Issuance Request)**: The Wallet Instance:

* Constructs the Wallet Attestation Request in the form of a JWT. This JWT includes the ``key_attestation``, ``hardware_signature``, ``nonce``, ``hardware_key_tag``, ``cnf`` and other configuration related parameters (see :ref:`Table of the Wallet Attestation Request Body <tbl_wallet_attestation_request_claim>`) and is signed using the private key of the initially generated ephemeral key pair.
* Submits the Wallet Attestation Request to the :ref:`Wallet Attestation Issuance endpoint` of the Wallet Provider Backend.

Below is a non-normative example of the Wallet Attestation Request JWT without encoding and signature applied:

.. code-block::

  {
    "alg": "ES256",
    "kid": "vbeXJksM45xphtANnCiG6mCyuU4jfGNzopGuKvogg9c",
    "typ": "war+jwt"
  }
  .
  {
    "iss": "https://wallet-provider.example.org/instance/vbeXJksM45xphtANnCiG6mCyuU4jfGNzopGuKvogg9c",
    "sub": "https://wallet-provider.example.org/",
    "nonce": "6ec69324-60a8-4e5b-a697-a766d85790ea",
    "hardware_signature": "KoZIhvcNAQcCoIAwgAIB...redacted",
    "key_attestation": "o2NmbXRvYXBwbGUtYXBwYX...redacted",
    "hardware_key_tag": "WQhyDymFKsP95iFqpzdEDWW4l7aVna2Fn4JCeWHYtbU=",
    "cnf": {
      "jwk": {
        "crv": "P-256",
        "kty": "EC",
        "x": "4HNptI-xr2pjyRJKGMnz4WmdnQD_uJSq4R95Nj98b44",
        "y": "LIZnSB39vFJhYgS3k7jXE4r3-CoGFQwZtPBIRqpNlrg"
      }
    },
    "iat": 1686645115,
    "exp": 1686652315
  }


The Wallet Instance MUST send the signed Wallet Attestation Request JWT as an ``assertion`` parameter in the body of an HTTP request to the Wallet Provider's :ref:`Wallet Attestation Issuance endpoint`.

Below is a non-normative example of a Wallet Attestation Issuance Request.

.. code-block:: http

    POST /wallet-attestation HTTP/1.1
    Host: wallet-provider.example.org
    Content-Type: application/json

    {
      "assertion": "eyJhbGciOiJFUzI1NiIsImtpZCI6ImtoakZWTE9nRjNHeG..."
    }

**Steps 13-17**: The Wallet Provider Backend evaluates the Wallet Attestation Request and MUST perform the following checks:

  1. The request MUST include all required HTTP header parameters as defined in :ref:`Wallet Attestation Issuance Request`.
  2. The signature of the Wallet Attestation Request MUST be valid and verifiable using the provided ``jwk``.
  3. The ``nonce`` value MUST have been generated by the Wallet Provider and not previously used.
  4. A valid and currently registered Wallet Instance associated with the provided MUST exist.
  5. The ``client_data`` MUST be reconstructed using the ``nonce`` and the ``jwk`` public key.  The ``hardware_signature`` parameter value is then validated using the registered Cryptographic Hardware Key's public key associated with the Wallet Instance.
  6. The ``key_attestation`` MUST be validated according to the device manufacturer's guidelines.  The specific checks performed by the Wallet Provider are detailed in the operating system manufacturer's documentation.
  7. The device in use MUST be free of known security flaws and meet the minimum security requirements defined by the Wallet Provider.
  8. The URL in the ``iss`` parameter MUST match the Wallet Provider's URL identifier.

Upon successful completion of all checks, the Wallet Provider issues a Wallet Attestation valid for a maximum of 24 hours.

**Step 18 (Wallet Attestation Issuance Response)**:  Upon successful completion, the Wallet Provider MUST return a confirmation response using status code 200 and Content-Type ``application/json``, containing the Wallet Attestations signed by the Wallet Provider. The Wallet provider MUST return the Wallet Attestation in at least three formats: JWT, SD-JWT and mdoc. The Wallet Instance will then perform security and integrity verification of the Wallet Attestations received in addition to trust verification of its Issuer.


Below is a non-normative example of the response.

.. code-block:: http

    HTTP/1.1 200 OK
    Content-Type: application/json

    {
      "wallet_attestations": [
        {
          "format": "jwt",
          "wallet_attestation": "ey..."
        },
        {
          "format": "dc+sd-jwt",
          "wallet_attestation": "ey..."
        },
        {
          "format": "mso_mdoc",
          "wallet_attestation": "omppc3N1ZXJBdXRohEOhASahG...ArQwggKwMIICVqADAgEC"
        }
      ]
    }



